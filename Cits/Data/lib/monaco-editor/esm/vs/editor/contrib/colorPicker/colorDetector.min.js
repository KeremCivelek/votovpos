/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/monaco-editor@0.27.0/esm/vs/editor/contrib/colorPicker/colorDetector.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __decorate=this&&this.__decorate||function(o,e,t,r){var i,s=arguments.length,n=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(o,e,t,r);else for(var a=o.length-1;a>=0;a--)(i=o[a])&&(n=(s<3?i(n):s>3?i(e,t,n):i(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n},__param=this&&this.__param||function(o,e){return function(t,r){e(t,r,o)}};import{TimeoutTimer,createCancelablePromise}from"../../../base/common/async.js";import{RGBA}from"../../../base/common/color.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{hash}from"../../../base/common/hash.js";import{Disposable,DisposableStore}from"../../../base/common/lifecycle.js";import{registerEditorContribution}from"../../browser/editorExtensions.js";import{ICodeEditorService}from"../../browser/services/codeEditorService.js";import{Range}from"../../common/core/range.js";import{ModelDecorationOptions}from"../../common/model/textModel.js";import{ColorProviderRegistry}from"../../common/modes.js";import{getColors}from"./color.js";import{IConfigurationService}from"../../../platform/configuration/common/configuration.js";const MAX_DECORATORS=500;let ColorDetector=class o extends Disposable{constructor(o,e,t){super(),this._editor=o,this._codeEditorService=e,this._configurationService=t,this._localToDispose=this._register(new DisposableStore),this._decorationsIds=[],this._colorDatas=new Map,this._colorDecoratorIds=[],this._decorationsTypes=new Set,this._register(o.onDidChangeModel((()=>{this._isEnabled=this.isEnabled(),this.onModelChanged()}))),this._register(o.onDidChangeModelLanguage((()=>this.onModelChanged()))),this._register(ColorProviderRegistry.onDidChange((()=>this.onModelChanged()))),this._register(o.onDidChangeConfiguration((()=>{let o=this._isEnabled;this._isEnabled=this.isEnabled(),o!==this._isEnabled&&(this._isEnabled?this.onModelChanged():this.removeAllDecorations())}))),this._timeoutTimer=null,this._computePromise=null,this._isEnabled=this.isEnabled(),this.onModelChanged()}isEnabled(){const o=this._editor.getModel();if(!o)return!1;const e=o.getLanguageIdentifier(),t=this._configurationService.getValue(e.language);if(t&&"object"==typeof t){const o=t.colorDecorators;if(o&&void 0!==o.enable&&!o.enable)return o.enable}return this._editor.getOption(15)}static get(o){return o.getContribution(this.ID)}dispose(){this.stop(),this.removeAllDecorations(),super.dispose()}onModelChanged(){if(this.stop(),!this._isEnabled)return;const e=this._editor.getModel();e&&ColorProviderRegistry.has(e)&&(this._localToDispose.add(this._editor.onDidChangeModelContent((()=>{this._timeoutTimer||(this._timeoutTimer=new TimeoutTimer,this._timeoutTimer.cancelAndSet((()=>{this._timeoutTimer=null,this.beginCompute()}),o.RECOMPUTE_TIME))}))),this.beginCompute())}beginCompute(){this._computePromise=createCancelablePromise((o=>{const e=this._editor.getModel();return e?getColors(e,o):Promise.resolve([])})),this._computePromise.then((o=>{this.updateDecorations(o),this.updateColorDecorators(o),this._computePromise=null}),onUnexpectedError)}stop(){this._timeoutTimer&&(this._timeoutTimer.cancel(),this._timeoutTimer=null),this._computePromise&&(this._computePromise.cancel(),this._computePromise=null),this._localToDispose.clear()}updateDecorations(o){const e=o.map((o=>({range:{startLineNumber:o.colorInfo.range.startLineNumber,startColumn:o.colorInfo.range.startColumn,endLineNumber:o.colorInfo.range.endLineNumber,endColumn:o.colorInfo.range.endColumn},options:ModelDecorationOptions.EMPTY})));this._decorationsIds=this._editor.deltaDecorations(this._decorationsIds,e),this._colorDatas=new Map,this._decorationsIds.forEach(((e,t)=>this._colorDatas.set(e,o[t])))}updateColorDecorators(o){let e=[],t={};for(let r=0;r<o.length&&e.length<500;r++){const{red:i,green:s,blue:n,alpha:a}=o[r].colorInfo.color,c=new RGBA(Math.round(255*i),Math.round(255*s),Math.round(255*n),a);let l=hash(`rgba(${c.r},${c.g},${c.b},${c.a})`).toString(16),d=`rgba(${c.r}, ${c.g}, ${c.b}, ${c.a})`,h="colorBox-"+l;this._decorationsTypes.has(h)||t[h]||this._codeEditorService.registerDecorationType("color-detector-color",h,{before:{contentText:" ",border:"solid 0.1em #000",margin:"0.1em 0.2em 0 0.2em",width:"0.8em",height:"0.8em",backgroundColor:d},dark:{before:{border:"solid 0.1em #eee"}}},void 0,this._editor),t[h]=!0,e.push({range:{startLineNumber:o[r].colorInfo.range.startLineNumber,startColumn:o[r].colorInfo.range.startColumn,endLineNumber:o[r].colorInfo.range.endLineNumber,endColumn:o[r].colorInfo.range.endColumn},options:this._codeEditorService.resolveDecorationOptions(h,!0)})}this._decorationsTypes.forEach((o=>{t[o]||this._codeEditorService.removeDecorationType(o)})),this._colorDecoratorIds=this._editor.deltaDecorations(this._colorDecoratorIds,e)}removeAllDecorations(){this._decorationsIds=this._editor.deltaDecorations(this._decorationsIds,[]),this._colorDecoratorIds=this._editor.deltaDecorations(this._colorDecoratorIds,[]),this._decorationsTypes.forEach((o=>{this._codeEditorService.removeDecorationType(o)}))}getColorData(o){const e=this._editor.getModel();if(!e)return null;const t=e.getDecorationsInRange(Range.fromPositions(o,o)).filter((o=>this._colorDatas.has(o.id)));return 0===t.length?null:this._colorDatas.get(t[0].id)}};ColorDetector.ID="editor.contrib.colorDetector",ColorDetector.RECOMPUTE_TIME=1e3,ColorDetector=__decorate([__param(1,ICodeEditorService),__param(2,IConfigurationService)],ColorDetector);export{ColorDetector};registerEditorContribution(ColorDetector.ID,ColorDetector);
//# sourceMappingURL=/sm/c39ccda1d513e34221970f292f28c3a57b0d32fdf8f9ac38ab65d93859d0de0b.map