/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/monaco-editor@0.27.0/esm/vs/editor/contrib/snippet/snippetSession.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{groupBy}from"../../../base/common/arrays.js";import{dispose}from"../../../base/common/lifecycle.js";import{getLeadingWhitespace}from"../../../base/common/strings.js";import"./snippetSession.css";import{EditOperation}from"../../common/core/editOperation.js";import{Range}from"../../common/core/range.js";import{Selection}from"../../common/core/selection.js";import{ModelDecorationOptions}from"../../common/model/textModel.js";import{IWorkspaceContextService}from"../../../platform/workspace/common/workspace.js";import{optional}from"../../../platform/instantiation/common/instantiation.js";import{Choice,Placeholder,SnippetParser,Text}from"./snippetParser.js";import{ClipboardBasedVariableResolver,CompositeSnippetVariableResolver,ModelBasedVariableResolver,SelectionBasedVariableResolver,TimeBasedVariableResolver,CommentBasedVariableResolver,WorkspaceBasedVariableResolver,RandomBasedVariableResolver}from"./snippetVariables.js";import{registerThemingParticipant}from"../../../platform/theme/common/themeService.js";import*as colors from"../../../platform/theme/common/colorRegistry.js";import{ILabelService}from"../../../platform/label/common/label.js";registerThemingParticipant(((e,t)=>{function o(t){const o=e.getColor(t);return o?o.toString():"transparent"}t.addRule(`.monaco-editor .snippet-placeholder { background-color: ${o(colors.snippetTabstopHighlightBackground)}; outline-color: ${o(colors.snippetTabstopHighlightBorder)}; }`),t.addRule(`.monaco-editor .finish-snippet-placeholder { background-color: ${o(colors.snippetFinalTabstopHighlightBackground)}; outline-color: ${o(colors.snippetFinalTabstopHighlightBorder)}; }`)}));export class OneSnippet{constructor(e,t,o,i){this._editor=e,this._snippet=t,this._offset=o,this._snippetLineLeadingWhitespace=i,this._nestingLevel=1,this._placeholderGroups=groupBy(t.placeholders,Placeholder.compareByIndex),this._placeholderGroupsIdx=-1}dispose(){this._placeholderDecorations&&this._editor.deltaDecorations([...this._placeholderDecorations.values()],[]),this._placeholderGroups.length=0}_initDecorations(){if(this._placeholderDecorations)return;this._placeholderDecorations=new Map;const e=this._editor.getModel();this._editor.changeDecorations((t=>{for(const o of this._snippet.placeholders){const i=this._snippet.offset(o),s=this._snippet.fullLen(o),n=Range.fromPositions(e.getPositionAt(this._offset+i),e.getPositionAt(this._offset+i+s)),r=o.isFinalTabstop?OneSnippet._decor.inactiveFinal:OneSnippet._decor.inactive,a=t.addDecoration(n,r);this._placeholderDecorations.set(o,a)}}))}move(e){if(!this._editor.hasModel())return[];if(this._initDecorations(),this._placeholderGroupsIdx>=0){let e=[];for(const t of this._placeholderGroups[this._placeholderGroupsIdx])if(t.transform){const o=this._placeholderDecorations.get(t),i=this._editor.getModel().getDecorationRange(o),s=this._editor.getModel().getValueInRange(i),n=t.transform.resolve(s).split(/\r\n|\r|\n/);for(let e=1;e<n.length;e++)n[e]=this._editor.getModel().normalizeIndentation(this._snippetLineLeadingWhitespace+n[e]);e.push(EditOperation.replace(i,n.join(this._editor.getModel().getEOL())))}e.length>0&&this._editor.executeEdits("snippet.placeholderTransform",e)}let t=!1;!0===e&&this._placeholderGroupsIdx<this._placeholderGroups.length-1?(this._placeholderGroupsIdx+=1,t=!0):!1===e&&this._placeholderGroupsIdx>0&&(this._placeholderGroupsIdx-=1,t=!0);const o=this._editor.getModel().changeDecorations((e=>{const o=new Set,i=[];for(const s of this._placeholderGroups[this._placeholderGroupsIdx]){const n=this._placeholderDecorations.get(s),r=this._editor.getModel().getDecorationRange(n);i.push(new Selection(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn)),t=t&&this._hasPlaceholderBeenCollapsed(s),e.changeDecorationOptions(n,s.isFinalTabstop?OneSnippet._decor.activeFinal:OneSnippet._decor.active),o.add(s);for(const t of this._snippet.enclosingPlaceholders(s)){const i=this._placeholderDecorations.get(t);e.changeDecorationOptions(i,t.isFinalTabstop?OneSnippet._decor.activeFinal:OneSnippet._decor.active),o.add(t)}}for(const[t,i]of this._placeholderDecorations)o.has(t)||e.changeDecorationOptions(i,t.isFinalTabstop?OneSnippet._decor.inactiveFinal:OneSnippet._decor.inactive);return i}));return t?this.move(e):null!=o?o:[]}_hasPlaceholderBeenCollapsed(e){let t=e;for(;t;){if(t instanceof Placeholder){const e=this._placeholderDecorations.get(t);if(this._editor.getModel().getDecorationRange(e).isEmpty()&&t.toString().length>0)return!0}t=t.parent}return!1}get isAtFirstPlaceholder(){return this._placeholderGroupsIdx<=0||0===this._placeholderGroups.length}get isAtLastPlaceholder(){return this._placeholderGroupsIdx===this._placeholderGroups.length-1}get hasPlaceholder(){return this._snippet.placeholders.length>0}computePossibleSelections(){const e=new Map;for(const t of this._placeholderGroups){let o;for(const i of t){if(i.isFinalTabstop)break;o||(o=[],e.set(i.index,o));const t=this._placeholderDecorations.get(i),s=this._editor.getModel().getDecorationRange(t);if(!s){e.delete(i.index);break}o.push(s)}}return e}get choice(){return this._placeholderGroups[this._placeholderGroupsIdx][0].choice}merge(e){const t=this._editor.getModel();this._nestingLevel*=10,this._editor.changeDecorations((o=>{for(const i of this._placeholderGroups[this._placeholderGroupsIdx]){const s=e.shift();console.assert(!s._placeholderDecorations);const n=s._snippet.placeholderInfo.last.index;for(const e of s._snippet.placeholderInfo.all)e.isFinalTabstop?e.index=i.index+(n+1)/this._nestingLevel:e.index=i.index+e.index/this._nestingLevel;this._snippet.replace(i,s._snippet.children);const r=this._placeholderDecorations.get(i);o.removeDecoration(r),this._placeholderDecorations.delete(i);for(const e of s._snippet.placeholders){const i=s._snippet.offset(e),n=s._snippet.fullLen(e),r=Range.fromPositions(t.getPositionAt(s._offset+i),t.getPositionAt(s._offset+i+n)),a=o.addDecoration(r,OneSnippet._decor.inactive);this._placeholderDecorations.set(e,a)}}this._placeholderGroups=groupBy(this._snippet.placeholders,Placeholder.compareByIndex)}))}}OneSnippet._decor={active:ModelDecorationOptions.register({description:"snippet-placeholder-1",stickiness:0,className:"snippet-placeholder"}),inactive:ModelDecorationOptions.register({description:"snippet-placeholder-2",stickiness:1,className:"snippet-placeholder"}),activeFinal:ModelDecorationOptions.register({description:"snippet-placeholder-3",stickiness:1,className:"finish-snippet-placeholder"}),inactiveFinal:ModelDecorationOptions.register({description:"snippet-placeholder-4",stickiness:1,className:"finish-snippet-placeholder"})};const _defaultOptions={overwriteBefore:0,overwriteAfter:0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};export class SnippetSession{constructor(e,t,o=_defaultOptions){this._templateMerges=[],this._snippets=[],this._editor=e,this._template=t,this._options=o}static adjustWhitespace(e,t,o,i,s){const n=e.getLineContent(t.lineNumber),r=getLeadingWhitespace(n,0,t.column-1);let a;return o.walk((t=>{if(!(t instanceof Text)||t.parent instanceof Choice)return!0;const s=t.value.split(/\r\n|\r|\n/);if(i){const i=o.offset(t);if(0===i)s[0]=e.normalizeIndentation(s[0]);else{a=null!=a?a:o.toString();let t=a.charCodeAt(i-1);10!==t&&13!==t||(s[0]=e.normalizeIndentation(r+s[0]))}for(let t=1;t<s.length;t++)s[t]=e.normalizeIndentation(r+s[t])}const n=s.join(e.getEOL());return n!==t.value&&(t.parent.replace(t,[new Text(n)]),a=void 0),!0})),r}static adjustSelection(e,t,o,i){if(0!==o||0!==i){const{positionLineNumber:s,positionColumn:n}=t,r=n-o,a=n+i,l=e.validateRange({startLineNumber:s,startColumn:r,endLineNumber:s,endColumn:a});t=Selection.createWithDirection(l.startLineNumber,l.startColumn,l.endLineNumber,l.endColumn,t.getDirection())}return t}static createEditsAndSnippets(e,t,o,i,s,n,r,a){const l=[],p=[];if(!e.hasModel())return{edits:l,snippets:p};const c=e.getModel(),d=e.invokeWithinContext((e=>e.get(IWorkspaceContextService,optional))),h=e.invokeWithinContext((e=>new ModelBasedVariableResolver(e.get(ILabelService,optional),c))),g=()=>r;let m=0,_=c.getValueInRange(SnippetSession.adjustSelection(c,e.getSelection(),o,0)),u=c.getValueInRange(SnippetSession.adjustSelection(c,e.getSelection(),0,i)),f=c.getLineFirstNonWhitespaceColumn(e.getSelection().positionLineNumber);const S=e.getSelections().map(((e,t)=>({selection:e,idx:t}))).sort(((e,t)=>Range.compareRangesUsingStarts(e.selection,t.selection)));for(const{selection:r,idx:v}of S){let b=SnippetSession.adjustSelection(c,r,o,0),R=SnippetSession.adjustSelection(c,r,0,i);_!==c.getValueInRange(b)&&(b=r),u!==c.getValueInRange(R)&&(R=r);const P=r.setStartPosition(b.startLineNumber,b.startColumn).setEndPosition(R.endLineNumber,R.endColumn),x=(new SnippetParser).parse(t,!0,s),D=P.getStartPosition(),I=SnippetSession.adjustWhitespace(c,D,x,n||v>0&&f!==c.getLineFirstNonWhitespaceColumn(r.positionLineNumber),!0);x.resolveVariables(new CompositeSnippetVariableResolver([h,new ClipboardBasedVariableResolver(g,v,S.length,"spread"===e.getOption(69)),new SelectionBasedVariableResolver(c,r,v,a),new CommentBasedVariableResolver(c,r),new TimeBasedVariableResolver,new WorkspaceBasedVariableResolver(d),new RandomBasedVariableResolver]));const L=c.getOffsetAt(D)+m;m+=x.toString().length-c.getValueLengthInRange(P),l[v]=EditOperation.replace(P,x.toString()),l[v].identifier={major:v,minor:0},p[v]=new OneSnippet(e,x,L,I)}return{edits:l,snippets:p}}dispose(){dispose(this._snippets)}_logInfo(){return`template="${this._template}", merged_templates="${this._templateMerges.join(" -> ")}"`}insert(){if(!this._editor.hasModel())return;const{edits:e,snippets:t}=SnippetSession.createEditsAndSnippets(this._editor,this._template,this._options.overwriteBefore,this._options.overwriteAfter,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer);this._snippets=t,this._editor.executeEdits("snippet",e,(e=>this._snippets[0].hasPlaceholder?this._move(!0):e.filter((e=>!!e.identifier)).map((e=>Selection.fromPositions(e.range.getEndPosition()))))),this._editor.revealRange(this._editor.getSelections()[0])}merge(e,t=_defaultOptions){if(!this._editor.hasModel())return;this._templateMerges.push([this._snippets[0]._nestingLevel,this._snippets[0]._placeholderGroupsIdx,e]);const{edits:o,snippets:i}=SnippetSession.createEditsAndSnippets(this._editor,e,t.overwriteBefore,t.overwriteAfter,!0,t.adjustWhitespace,t.clipboardText,t.overtypingCapturer);this._editor.executeEdits("snippet",o,(e=>{for(const e of this._snippets)e.merge(i);return console.assert(0===i.length),this._snippets[0].hasPlaceholder?this._move(void 0):e.filter((e=>!!e.identifier)).map((e=>Selection.fromPositions(e.range.getEndPosition())))}))}next(){const e=this._move(!0);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}prev(){const e=this._move(!1);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}_move(e){const t=[];for(const o of this._snippets){const i=o.move(e);t.push(...i)}return t}get isAtFirstPlaceholder(){return this._snippets[0].isAtFirstPlaceholder}get isAtLastPlaceholder(){return this._snippets[0].isAtLastPlaceholder}get hasPlaceholder(){return this._snippets[0].hasPlaceholder}get choice(){return this._snippets[0].choice}isSelectionWithinPlaceholders(){if(!this.hasPlaceholder)return!1;const e=this._editor.getSelections();if(e.length<this._snippets.length)return!1;let t=new Map;for(const o of this._snippets){const i=o.computePossibleSelections();if(0===t.size)for(const[o,s]of i){s.sort(Range.compareRangesUsingStarts);for(const i of e)if(s[0].containsRange(i)){t.set(o,[]);break}}if(0===t.size)return!1;t.forEach(((e,t)=>{e.push(...i.get(t))}))}e.sort(Range.compareRangesUsingStarts);for(let[o,i]of t)if(i.length===e.length){i.sort(Range.compareRangesUsingStarts);for(let s=0;s<i.length;s++)i[s].containsRange(e[s])||t.delete(o)}else t.delete(o);return t.size>0}}
//# sourceMappingURL=/sm/4c22423a8e7aefd869d760e7bcda11f0535e7c02d74957fb2f8fa4ac776a3095.map