/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/monaco-editor@0.27.0/esm/vs/editor/contrib/suggest/suggestController.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __decorate=this&&this.__decorate||function(e,t,i,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var g=e.length-1;g>=0;g--)(s=e[g])&&(r=(n<3?s(r):n>3?s(t,i,r):s(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import{alert}from"../../../base/browser/ui/aria/aria.js";import{isNonEmptyArray}from"../../../base/common/arrays.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{SimpleKeybinding}from"../../../base/common/keyCodes.js";import{dispose,DisposableStore,toDisposable,MutableDisposable}from"../../../base/common/lifecycle.js";import{StableEditorScrollState}from"../../browser/core/editorState.js";import{EditorAction,EditorCommand,registerEditorAction,registerEditorCommand,registerEditorContribution}from"../../browser/editorExtensions.js";import{EditOperation}from"../../common/core/editOperation.js";import{Range}from"../../common/core/range.js";import{EditorContextKeys}from"../../common/editorContextKeys.js";import{SnippetController2}from"../snippet/snippetController2.js";import{SnippetParser}from"../snippet/snippetParser.js";import{ISuggestMemoryService}from"./suggestMemory.js";import*as nls from"../../../nls.js";import{ICommandService,CommandsRegistry}from"../../../platform/commands/common/commands.js";import{ContextKeyExpr,IContextKeyService}from"../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry}from"../../../platform/keybinding/common/keybindingsRegistry.js";import{Context as SuggestContext,suggestWidgetStatusbarMenu}from"./suggest.js";import{SuggestAlternatives}from"./suggestAlternatives.js";import{SuggestModel}from"./suggestModel.js";import{SuggestWidget}from"./suggestWidget.js";import{WordContextKey}from"./wordContextKey.js";import{Event}from"../../../base/common/event.js";import{IdleValue}from"../../../base/common/async.js";import{isObject,assertType}from"../../../base/common/types.js";import{CommitCharacterController}from"./suggestCommitCharacters.js";import{OvertypingCapturer}from"./suggestOvertypingCapturer.js";import{Position}from"../../common/core/position.js";import*as platform from"../../../base/common/platform.js";import{MenuRegistry}from"../../../platform/actions/common/actions.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{ILogService}from"../../../platform/log/common/log.js";import{StopWatch}from"../../../base/common/stopwatch.js";let _sticky=!1;class LineSuffix{constructor(e,t){this._model=e,this._position=t;if(e.getLineMaxColumn(t.lineNumber)!==t.column){const i=e.getOffsetAt(t),o=e.getPositionAt(i+1);this._marker=e.deltaDecorations([],[{range:Range.fromPositions(t,o),options:{description:"suggest-line-suffix",stickiness:1}}])}}dispose(){this._marker&&!this._model.isDisposed()&&this._model.deltaDecorations(this._marker,[])}delta(e){if(this._model.isDisposed()||this._position.lineNumber!==e.lineNumber)return 0;if(this._marker){const t=this._model.getDecorationRange(this._marker[0]);return this._model.getOffsetAt(t.getStartPosition())-this._model.getOffsetAt(e)}return this._model.getLineMaxColumn(e.lineNumber)-e.column}}let SuggestController=class e{constructor(e,t,i,o,s,n){this._memoryService=t,this._commandService=i,this._contextKeyService=o,this._instantiationService=s,this._logService=n,this._lineSuffix=new MutableDisposable,this._toDispose=new DisposableStore,this.editor=e,this.model=s.createInstance(SuggestModel,this.editor);const r=SuggestContext.InsertMode.bindTo(o);r.set(e.getOption(105).insertMode),this.model.onDidTrigger((()=>r.set(e.getOption(105).insertMode))),this.widget=this._toDispose.add(new IdleValue((()=>{const e=this._instantiationService.createInstance(SuggestWidget,this.editor);this._toDispose.add(e),this._toDispose.add(e.onDidSelect((e=>this._insertSuggestion(e,0)),this));const t=new CommitCharacterController(this.editor,e,(e=>this._insertSuggestion(e,2)));this._toDispose.add(t),this._toDispose.add(this.model.onDidSuggest((e=>{0===e.completionModel.items.length&&t.reset()})));const i=SuggestContext.MakesTextEdit.bindTo(this._contextKeyService),o=SuggestContext.HasInsertAndReplaceRange.bindTo(this._contextKeyService),s=SuggestContext.CanResolve.bindTo(this._contextKeyService);return this._toDispose.add(toDisposable((()=>{i.reset(),o.reset(),s.reset()}))),this._toDispose.add(e.onDidFocus((({item:e})=>{const t=this.editor.getPosition(),n=e.editStart.column,r=t.column;let g=!0;if(!("smart"!==this.editor.getOption(1)||2!==this.model.state||e.completion.command||e.completion.additionalTextEdits||4&e.completion.insertTextRules||r-n!==e.completion.insertText.length)){g=this.editor.getModel().getValueInRange({startLineNumber:t.lineNumber,startColumn:n,endLineNumber:t.lineNumber,endColumn:r})!==e.completion.insertText}i.set(g),o.set(!Position.equals(e.editInsertEnd,e.editReplaceEnd)),s.set(Boolean(e.provider.resolveCompletionItem)||Boolean(e.completion.documentation)||e.completion.detail!==e.completion.label)}))),this._toDispose.add(e.onDetailsKeyDown((e=>{e.toKeybinding().equals(new SimpleKeybinding(!0,!1,!1,!1,33))||platform.isMacintosh&&e.toKeybinding().equals(new SimpleKeybinding(!1,!1,!1,!0,33))?e.stopPropagation():e.toKeybinding().isModifierKey()||this.editor.focus()}))),e}))),this._overtypingCapturer=this._toDispose.add(new IdleValue((()=>this._toDispose.add(new OvertypingCapturer(this.editor,this.model))))),this._alternatives=this._toDispose.add(new IdleValue((()=>this._toDispose.add(new SuggestAlternatives(this.editor,this._contextKeyService))))),this._toDispose.add(s.createInstance(WordContextKey,e)),this._toDispose.add(this.model.onDidTrigger((e=>{this.widget.value.showTriggered(e.auto,e.shy?250:50),this._lineSuffix.value=new LineSuffix(this.editor.getModel(),e.position)}))),this._toDispose.add(this.model.onDidSuggest((e=>{if(!e.shy){let t=this._memoryService.select(this.editor.getModel(),this.editor.getPosition(),e.completionModel.items);this.widget.value.showSuggestions(e.completionModel,t,e.isFrozen,e.auto)}}))),this._toDispose.add(this.model.onDidCancel((e=>{e.retrigger||this.widget.value.hideWidget()}))),this._toDispose.add(this.editor.onDidBlurEditorWidget((()=>{_sticky||(this.model.cancel(),this.model.clear())})));let g=SuggestContext.AcceptSuggestionsOnEnter.bindTo(o),d=()=>{const e=this.editor.getOption(1);g.set("on"===e||"smart"===e)};this._toDispose.add(this.editor.onDidChangeConfiguration((()=>d()))),d()}static get(t){return t.getContribution(e.ID)}dispose(){this._alternatives.dispose(),this._toDispose.dispose(),this.widget.dispose(),this.model.dispose(),this._lineSuffix.dispose()}_insertSuggestion(e,t){if(!e||!e.item)return this._alternatives.value.reset(),this.model.cancel(),void this.model.clear();if(!this.editor.hasModel())return;const i=this.editor.getModel(),o=i.getAlternativeVersionId(),{item:s}=e,n=[],r=new CancellationTokenSource;1&t||this.editor.pushUndoStop();const g=this.getOverwriteInfo(s,Boolean(8&t));if(this._memoryService.memorize(i,this.editor.getPosition(),s),Array.isArray(s.completion.additionalTextEdits)){const e=StableEditorScrollState.capture(this.editor);this.editor.executeEdits("suggestController.additionalTextEdits.sync",s.completion.additionalTextEdits.map((e=>EditOperation.replace(Range.lift(e.range),e.text)))),e.restoreRelativeVerticalPositionOfCursor(this.editor)}else if(!s.isResolved){const e=new StopWatch(!0);let o;const g=i.onDidChangeContent((e=>{if(e.isFlush)return r.cancel(),void g.dispose();for(let t of e.changes){const e=Range.getEndPosition(t.range);o&&!Position.isBefore(e,o)||(o=e)}}));let d=t;t|=2;let a=!1,l=this.editor.onWillType((()=>{l.dispose(),a=!0,2&d||this.editor.pushUndoStop()}));n.push(s.resolve(r.token).then((()=>{if(!s.completion.additionalTextEdits||r.token.isCancellationRequested)return!1;if(o&&s.completion.additionalTextEdits.some((e=>Position.isBefore(o,Range.getStartPosition(e.range)))))return!1;a&&this.editor.pushUndoStop();const e=StableEditorScrollState.capture(this.editor);return this.editor.executeEdits("suggestController.additionalTextEdits.async",s.completion.additionalTextEdits.map((e=>EditOperation.replace(Range.lift(e.range),e.text)))),e.restoreRelativeVerticalPositionOfCursor(this.editor),!a&&2&d||this.editor.pushUndoStop(),!0})).then((t=>{this._logService.trace("[suggest] async resolving of edits DONE (ms, applied?)",e.elapsed(),t),g.dispose(),l.dispose()})))}let{insertText:d}=s.completion;4&s.completion.insertTextRules||(d=SnippetParser.escape(d)),SnippetController2.get(this.editor).insert(d,{overwriteBefore:g.overwriteBefore,overwriteAfter:g.overwriteAfter,undoStopBefore:!1,undoStopAfter:!1,adjustWhitespace:!(1&s.completion.insertTextRules),clipboardText:e.model.clipboardText,overtypingCapturer:this._overtypingCapturer.value}),2&t||this.editor.pushUndoStop(),s.completion.command?s.completion.command.id===TriggerSuggestAction.id?this.model.trigger({auto:!0,shy:!1},!0):(n.push(this._commandService.executeCommand(s.completion.command.id,...s.completion.command.arguments?[...s.completion.command.arguments]:[]).catch(onUnexpectedError)),this.model.cancel()):this.model.cancel(),4&t&&this._alternatives.value.set(e,(e=>{for(r.cancel();i.canUndo();){o!==i.getAlternativeVersionId()&&i.undo(),this._insertSuggestion(e,3|(8&t?8:0));break}})),this._alertCompletionItem(s),Promise.all(n).finally((()=>{this.model.clear(),r.dispose()}))}getOverwriteInfo(e,t){assertType(this.editor.hasModel());let i="replace"===this.editor.getOption(105).insertMode;t&&(i=!i);const o=e.position.column-e.editStart.column,s=(i?e.editReplaceEnd.column:e.editInsertEnd.column)-e.position.column;return{overwriteBefore:o+(this.editor.getPosition().column-e.position.column),overwriteAfter:s+(this._lineSuffix.value?this._lineSuffix.value.delta(this.editor.getPosition()):0)}}_alertCompletionItem(e){if(isNonEmptyArray(e.completion.additionalTextEdits)){let t=nls.localize("aria.alert.snippet","Accepting '{0}' made {1} additional edits",e.textLabel,e.completion.additionalTextEdits.length);alert(t)}}triggerSuggest(e){this.editor.hasModel()&&(this.model.trigger({auto:!1,shy:!1},!1,e),this.editor.revealLine(this.editor.getPosition().lineNumber,0),this.editor.focus())}triggerSuggestAndAcceptBest(e){if(!this.editor.hasModel())return;const t=this.editor.getPosition(),i=()=>{t.equals(this.editor.getPosition())&&this._commandService.executeCommand(e.fallback)},o=e=>{if(4&e.completion.insertTextRules||e.completion.additionalTextEdits)return!0;const t=this.editor.getPosition(),i=e.editStart.column,o=t.column;if(o-i!==e.completion.insertText.length)return!0;return this.editor.getModel().getValueInRange({startLineNumber:t.lineNumber,startColumn:i,endLineNumber:t.lineNumber,endColumn:o})!==e.completion.insertText};Event.once(this.model.onDidTrigger)((e=>{let t=[];Event.any(this.model.onDidTrigger,this.model.onDidCancel)((()=>{dispose(t),i()}),void 0,t),this.model.onDidSuggest((({completionModel:e})=>{if(dispose(t),0===e.items.length)return void i();const s=this._memoryService.select(this.editor.getModel(),this.editor.getPosition(),e.items),n=e.items[s];o(n)?(this.editor.pushUndoStop(),this._insertSuggestion({index:s,item:n,model:e},7)):i()}),void 0,t)})),this.model.trigger({auto:!1,shy:!0}),this.editor.revealLine(t.lineNumber,0),this.editor.focus()}acceptSelectedSuggestion(e,t){const i=this.widget.value.getFocusedItem();let o=0;e&&(o|=4),t&&(o|=8),this._insertSuggestion(i,o)}acceptNextSuggestion(){this._alternatives.value.next()}acceptPrevSuggestion(){this._alternatives.value.prev()}cancelSuggestWidget(){this.model.cancel(),this.model.clear(),this.widget.value.hideWidget()}selectNextSuggestion(){this.widget.value.selectNext()}selectNextPageSuggestion(){this.widget.value.selectNextPage()}selectLastSuggestion(){this.widget.value.selectLast()}selectPrevSuggestion(){this.widget.value.selectPrevious()}selectPrevPageSuggestion(){this.widget.value.selectPreviousPage()}selectFirstSuggestion(){this.widget.value.selectFirst()}toggleSuggestionDetails(){this.widget.value.toggleDetails()}toggleExplainMode(){this.widget.value.toggleExplainMode()}toggleSuggestionFocus(){this.widget.value.toggleDetailsFocus()}resetWidgetSize(){this.widget.value.resetPersistedSize()}forceRenderingAbove(){this.widget.value.forceRenderingAbove()}stopForceRenderingAbove(){this.widget.value.stopForceRenderingAbove()}};SuggestController.ID="editor.contrib.suggestController",SuggestController=__decorate([__param(1,ISuggestMemoryService),__param(2,ICommandService),__param(3,IContextKeyService),__param(4,IInstantiationService),__param(5,ILogService)],SuggestController);export{SuggestController};export class TriggerSuggestAction extends EditorAction{constructor(){super({id:TriggerSuggestAction.id,label:nls.localize("suggest.trigger.label","Trigger Suggest"),alias:"Trigger Suggest",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasCompletionItemProvider),kbOpts:{kbExpr:EditorContextKeys.textInputFocus,primary:2058,secondary:[2087],mac:{primary:266,secondary:[521,2087]},weight:100}})}run(e,t){const i=SuggestController.get(t);i&&i.triggerSuggest()}}TriggerSuggestAction.id="editor.action.triggerSuggest",registerEditorContribution(SuggestController.ID,SuggestController),registerEditorAction(TriggerSuggestAction);const weight=190,SuggestCommand=EditorCommand.bindToContribution(SuggestController.get);registerEditorCommand(new SuggestCommand({id:"acceptSelectedSuggestion",precondition:SuggestContext.Visible,handler(e){e.acceptSelectedSuggestion(!0,!1)}})),KeybindingsRegistry.registerKeybindingRule({id:"acceptSelectedSuggestion",when:ContextKeyExpr.and(SuggestContext.Visible,EditorContextKeys.textInputFocus),primary:2,weight:190}),KeybindingsRegistry.registerKeybindingRule({id:"acceptSelectedSuggestion",when:ContextKeyExpr.and(SuggestContext.Visible,EditorContextKeys.textInputFocus,SuggestContext.AcceptSuggestionsOnEnter,SuggestContext.MakesTextEdit),primary:3,weight:190}),MenuRegistry.appendMenuItem(suggestWidgetStatusbarMenu,{command:{id:"acceptSelectedSuggestion",title:nls.localize("accept.insert","Insert")},group:"left",order:1,when:SuggestContext.HasInsertAndReplaceRange.toNegated()}),MenuRegistry.appendMenuItem(suggestWidgetStatusbarMenu,{command:{id:"acceptSelectedSuggestion",title:nls.localize("accept.insert","Insert")},group:"left",order:1,when:ContextKeyExpr.and(SuggestContext.HasInsertAndReplaceRange,SuggestContext.InsertMode.isEqualTo("insert"))}),MenuRegistry.appendMenuItem(suggestWidgetStatusbarMenu,{command:{id:"acceptSelectedSuggestion",title:nls.localize("accept.replace","Replace")},group:"left",order:1,when:ContextKeyExpr.and(SuggestContext.HasInsertAndReplaceRange,SuggestContext.InsertMode.isEqualTo("replace"))}),registerEditorCommand(new SuggestCommand({id:"acceptAlternativeSelectedSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,EditorContextKeys.textInputFocus),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:1027,secondary:[1026]},handler(e){e.acceptSelectedSuggestion(!1,!0)},menuOpts:[{menuId:suggestWidgetStatusbarMenu,group:"left",order:2,when:ContextKeyExpr.and(SuggestContext.HasInsertAndReplaceRange,SuggestContext.InsertMode.isEqualTo("insert")),title:nls.localize("accept.replace","Replace")},{menuId:suggestWidgetStatusbarMenu,group:"left",order:2,when:ContextKeyExpr.and(SuggestContext.HasInsertAndReplaceRange,SuggestContext.InsertMode.isEqualTo("replace")),title:nls.localize("accept.insert","Insert")}]})),CommandsRegistry.registerCommandAlias("acceptSelectedSuggestionOnEnter","acceptSelectedSuggestion"),registerEditorCommand(new SuggestCommand({id:"hideSuggestWidget",precondition:SuggestContext.Visible,handler:e=>e.cancelSuggestWidget(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:9,secondary:[1033]}})),registerEditorCommand(new SuggestCommand({id:"selectNextSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,SuggestContext.MultipleSuggestions),handler:e=>e.selectNextSuggestion(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:18,secondary:[2066],mac:{primary:18,secondary:[2066,300]}}})),registerEditorCommand(new SuggestCommand({id:"selectNextPageSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,SuggestContext.MultipleSuggestions),handler:e=>e.selectNextPageSuggestion(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:12,secondary:[2060]}})),registerEditorCommand(new SuggestCommand({id:"selectLastSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,SuggestContext.MultipleSuggestions),handler:e=>e.selectLastSuggestion()})),registerEditorCommand(new SuggestCommand({id:"selectPrevSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,SuggestContext.MultipleSuggestions),handler:e=>e.selectPrevSuggestion(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:16,secondary:[2064],mac:{primary:16,secondary:[2064,302]}}})),registerEditorCommand(new SuggestCommand({id:"selectPrevPageSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,SuggestContext.MultipleSuggestions),handler:e=>e.selectPrevPageSuggestion(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:11,secondary:[2059]}})),registerEditorCommand(new SuggestCommand({id:"selectFirstSuggestion",precondition:ContextKeyExpr.and(SuggestContext.Visible,SuggestContext.MultipleSuggestions),handler:e=>e.selectFirstSuggestion()})),registerEditorCommand(new SuggestCommand({id:"toggleSuggestionDetails",precondition:SuggestContext.Visible,handler:e=>e.toggleSuggestionDetails(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:2058,mac:{primary:266}},menuOpts:[{menuId:suggestWidgetStatusbarMenu,group:"right",order:1,when:ContextKeyExpr.and(SuggestContext.DetailsVisible,SuggestContext.CanResolve),title:nls.localize("detail.more","show less")},{menuId:suggestWidgetStatusbarMenu,group:"right",order:1,when:ContextKeyExpr.and(SuggestContext.DetailsVisible.toNegated(),SuggestContext.CanResolve),title:nls.localize("detail.less","show more")}]})),registerEditorCommand(new SuggestCommand({id:"toggleExplainMode",precondition:SuggestContext.Visible,handler:e=>e.toggleExplainMode(),kbOpts:{weight:100,primary:2133}})),registerEditorCommand(new SuggestCommand({id:"toggleSuggestionFocus",precondition:SuggestContext.Visible,handler:e=>e.toggleSuggestionFocus(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:2570,mac:{primary:778}}})),registerEditorCommand(new SuggestCommand({id:"insertBestCompletion",precondition:ContextKeyExpr.and(EditorContextKeys.textInputFocus,ContextKeyExpr.equals("config.editor.tabCompletion","on"),WordContextKey.AtEnd,SuggestContext.Visible.toNegated(),SuggestAlternatives.OtherSuggestions.toNegated(),SnippetController2.InSnippetMode.toNegated()),handler:(e,t)=>{e.triggerSuggestAndAcceptBest(isObject(t)?Object.assign({fallback:"tab"},t):{fallback:"tab"})},kbOpts:{weight:190,primary:2}})),registerEditorCommand(new SuggestCommand({id:"insertNextSuggestion",precondition:ContextKeyExpr.and(EditorContextKeys.textInputFocus,ContextKeyExpr.equals("config.editor.tabCompletion","on"),SuggestAlternatives.OtherSuggestions,SuggestContext.Visible.toNegated(),SnippetController2.InSnippetMode.toNegated()),handler:e=>e.acceptNextSuggestion(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:2}})),registerEditorCommand(new SuggestCommand({id:"insertPrevSuggestion",precondition:ContextKeyExpr.and(EditorContextKeys.textInputFocus,ContextKeyExpr.equals("config.editor.tabCompletion","on"),SuggestAlternatives.OtherSuggestions,SuggestContext.Visible.toNegated(),SnippetController2.InSnippetMode.toNegated()),handler:e=>e.acceptPrevSuggestion(),kbOpts:{weight:190,kbExpr:EditorContextKeys.textInputFocus,primary:1026}})),registerEditorAction(class extends EditorAction{constructor(){super({id:"editor.action.resetSuggestSize",label:nls.localize("suggest.reset.label","Reset Suggest Widget Size"),alias:"Reset Suggest Widget Size",precondition:void 0})}run(e,t){SuggestController.get(t).resetWidgetSize()}});
//# sourceMappingURL=/sm/395c702f38d5eb8c637b67fd8edaf30bdade69f6e43169cbc932559f26a32402.map