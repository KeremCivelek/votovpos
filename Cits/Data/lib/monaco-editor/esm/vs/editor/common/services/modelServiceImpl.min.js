/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/monaco-editor@0.27.0/esm/vs/editor/common/services/modelServiceImpl.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __decorate=this&&this.__decorate||function(e,t,o,i){var s,n=arguments.length,r=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,o,r):s(t,o))||r);return n>3&&r&&Object.defineProperty(t,o,r),r},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import{Emitter}from"../../../base/common/event.js";import{Disposable,DisposableStore,dispose}from"../../../base/common/lifecycle.js";import*as platform from"../../../base/common/platform.js";import*as errors from"../../../base/common/errors.js";import{EDITOR_MODEL_DEFAULTS}from"../config/editorOptions.js";import{TextModel}from"../model/textModel.js";import{DocumentSemanticTokensProviderRegistry}from"../modes.js";import{PLAINTEXT_LANGUAGE_IDENTIFIER}from"../modes/modesRegistry.js";import{ITextResourcePropertiesService}from"./textResourceConfigurationService.js";import{IConfigurationService}from"../../../platform/configuration/common/configuration.js";import{RunOnceScheduler}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{IThemeService}from"../../../platform/theme/common/themeService.js";import{ILogService}from"../../../platform/log/common/log.js";import{IUndoRedoService}from"../../../platform/undoRedo/common/undoRedo.js";import{StringSHA1}from"../../../base/common/hash.js";import{isEditStackElement}from"../model/editStack.js";import{Schemas}from"../../../base/common/network.js";import{SemanticTokensProviderStyling,toMultilineTokens2}from"./semanticTokensProviderStyling.js";import{getDocumentSemanticTokens,isSemanticTokens,isSemanticTokensEdits}from"./getSemanticTokens.js";function MODEL_ID(e){return e.toString()}function computeModelSha1(e){const t=new StringSHA1,o=e.createSnapshot();let i;for(;i=o.read();)t.update(i);return t.digest()}class ModelData{constructor(e,t,o){this._modelEventListeners=new DisposableStore,this.model=e,this._languageSelection=null,this._languageSelectionListener=null,this._modelEventListeners.add(e.onWillDispose((()=>t(e)))),this._modelEventListeners.add(e.onDidChangeLanguage((t=>o(e,t))))}_disposeLanguageSelection(){this._languageSelectionListener&&(this._languageSelectionListener.dispose(),this._languageSelectionListener=null)}dispose(){this._modelEventListeners.dispose(),this._disposeLanguageSelection()}setLanguage(e){this._disposeLanguageSelection(),this._languageSelection=e,this._languageSelectionListener=this._languageSelection.onDidChange((()=>this.model.setMode(e.languageIdentifier))),this.model.setMode(e.languageIdentifier)}}const DEFAULT_EOL=platform.isLinux||platform.isMacintosh?1:2;class DisposedModelInfo{constructor(e,t,o,i,s,n,r,a){this.uri=e,this.initialUndoRedoSnapshot=t,this.time=o,this.sharesUndoRedoStack=i,this.heapSize=s,this.sha1=n,this.versionId=r,this.alternativeVersionId=a}}function schemaShouldMaintainUndoRedoElements(e){return e.scheme===Schemas.file||e.scheme===Schemas.vscodeRemote||e.scheme===Schemas.userData||"fake-fs"===e.scheme}let ModelServiceImpl=class e extends Disposable{constructor(e,t,o,i,s){super(),this._configurationService=e,this._resourcePropertiesService=t,this._themeService=o,this._logService=i,this._undoRedoService=s,this._onModelAdded=this._register(new Emitter),this.onModelAdded=this._onModelAdded.event,this._onModelRemoved=this._register(new Emitter),this.onModelRemoved=this._onModelRemoved.event,this._onModelModeChanged=this._register(new Emitter),this.onModelModeChanged=this._onModelModeChanged.event,this._modelCreationOptionsByLanguageAndResource=Object.create(null),this._models={},this._disposedModels=new Map,this._disposedModelsHeapSize=0,this._semanticStyling=this._register(new SemanticStyling(this._themeService,this._logService)),this._register(this._configurationService.onDidChangeConfiguration((()=>this._updateModelOptions()))),this._updateModelOptions(),this._register(new SemanticColoringFeature(this,this._themeService,this._configurationService,this._semanticStyling))}static _readModelOptions(e,t){let o=EDITOR_MODEL_DEFAULTS.tabSize;if(e.editor&&void 0!==e.editor.tabSize){const t=parseInt(e.editor.tabSize,10);isNaN(t)||(o=t),o<1&&(o=1)}let i=o;if(e.editor&&void 0!==e.editor.indentSize&&"tabSize"!==e.editor.indentSize){const t=parseInt(e.editor.indentSize,10);isNaN(t)||(i=t),i<1&&(i=1)}let s=EDITOR_MODEL_DEFAULTS.insertSpaces;e.editor&&void 0!==e.editor.insertSpaces&&(s="false"!==e.editor.insertSpaces&&Boolean(e.editor.insertSpaces));let n=DEFAULT_EOL;const r=e.eol;"\r\n"===r?n=2:"\n"===r&&(n=1);let a=EDITOR_MODEL_DEFAULTS.trimAutoWhitespace;e.editor&&void 0!==e.editor.trimAutoWhitespace&&(a="false"!==e.editor.trimAutoWhitespace&&Boolean(e.editor.trimAutoWhitespace));let d=EDITOR_MODEL_DEFAULTS.detectIndentation;e.editor&&void 0!==e.editor.detectIndentation&&(d="false"!==e.editor.detectIndentation&&Boolean(e.editor.detectIndentation));let c=EDITOR_MODEL_DEFAULTS.largeFileOptimizations;return e.editor&&void 0!==e.editor.largeFileOptimizations&&(c="false"!==e.editor.largeFileOptimizations&&Boolean(e.editor.largeFileOptimizations)),{isForSimpleWidget:t,tabSize:o,indentSize:i,insertSpaces:s,detectIndentation:d,defaultEOL:n,trimAutoWhitespace:a,largeFileOptimizations:c}}_getEOL(e,t){if(e)return this._resourcePropertiesService.getEOL(e,t);const o=this._configurationService.getValue("files.eol",{overrideIdentifier:t});return o&&"string"==typeof o&&"auto"!==o?o:3===platform.OS||2===platform.OS?"\n":"\r\n"}_shouldRestoreUndoStack(){const e=this._configurationService.getValue("files.restoreUndoStack");return"boolean"!=typeof e||e}getCreationOptions(t,o,i){let s=this._modelCreationOptionsByLanguageAndResource[t+o];if(!s){const n=this._configurationService.getValue("editor",{overrideIdentifier:t,resource:o}),r=this._getEOL(o,t);s=e._readModelOptions({editor:n,eol:r},i),this._modelCreationOptionsByLanguageAndResource[t+o]=s}return s}_updateModelOptions(){const t=this._modelCreationOptionsByLanguageAndResource;this._modelCreationOptionsByLanguageAndResource=Object.create(null);const o=Object.keys(this._models);for(let i=0,s=o.length;i<s;i++){const s=o[i],n=this._models[s],r=n.model.getLanguageIdentifier().language,a=n.model.uri,d=t[r+a],c=this.getCreationOptions(r,a,n.model.isForSimpleWidget);e._setModelOptionsForModel(n.model,c,d)}}static _setModelOptionsForModel(e,t,o){o&&o.defaultEOL!==t.defaultEOL&&1===e.getLineCount()&&e.setEOL(1===t.defaultEOL?0:1),o&&o.detectIndentation===t.detectIndentation&&o.insertSpaces===t.insertSpaces&&o.tabSize===t.tabSize&&o.indentSize===t.indentSize&&o.trimAutoWhitespace===t.trimAutoWhitespace||(t.detectIndentation?(e.detectIndentation(t.insertSpaces,t.tabSize),e.updateOptions({trimAutoWhitespace:t.trimAutoWhitespace})):e.updateOptions({insertSpaces:t.insertSpaces,tabSize:t.tabSize,indentSize:t.indentSize,trimAutoWhitespace:t.trimAutoWhitespace}))}_insertDisposedModel(e){this._disposedModels.set(MODEL_ID(e.uri),e),this._disposedModelsHeapSize+=e.heapSize}_removeDisposedModel(e){const t=this._disposedModels.get(MODEL_ID(e));return t&&(this._disposedModelsHeapSize-=t.heapSize),this._disposedModels.delete(MODEL_ID(e)),t}_ensureDisposedModelsHeapSize(e){if(this._disposedModelsHeapSize>e){const t=[];for(this._disposedModels.forEach((e=>{e.sharesUndoRedoStack||t.push(e)})),t.sort(((e,t)=>e.time-t.time));t.length>0&&this._disposedModelsHeapSize>e;){const e=t.shift();this._removeDisposedModel(e.uri),null!==e.initialUndoRedoSnapshot&&this._undoRedoService.restoreSnapshot(e.initialUndoRedoSnapshot)}}}_createModelData(e,t,o,i){const s=this.getCreationOptions(t.language,o,i),n=new TextModel(e,s,t,o,this._undoRedoService);if(o&&this._disposedModels.has(MODEL_ID(o))){const e=this._removeDisposedModel(o),t=this._undoRedoService.getElements(o),i=computeModelSha1(n)===e.sha1;if(i||e.sharesUndoRedoStack){for(const e of t.past)isEditStackElement(e)&&e.matchesResource(o)&&e.setModel(n);for(const e of t.future)isEditStackElement(e)&&e.matchesResource(o)&&e.setModel(n);this._undoRedoService.setElementsValidFlag(o,!0,(e=>isEditStackElement(e)&&e.matchesResource(o))),i&&(n._overwriteVersionId(e.versionId),n._overwriteAlternativeVersionId(e.alternativeVersionId),n._overwriteInitialUndoRedoSnapshot(e.initialUndoRedoSnapshot))}else null!==e.initialUndoRedoSnapshot&&this._undoRedoService.restoreSnapshot(e.initialUndoRedoSnapshot)}const r=MODEL_ID(n.uri);if(this._models[r])throw new Error("ModelService: Cannot add model because it already exists!");const a=new ModelData(n,(e=>this._onWillDispose(e)),((e,t)=>this._onDidChangeLanguage(e,t)));return this._models[r]=a,a}createModel(e,t,o,i=!1){let s;return t?(s=this._createModelData(e,t.languageIdentifier,o,i),this.setMode(s.model,t)):s=this._createModelData(e,PLAINTEXT_LANGUAGE_IDENTIFIER,o,i),this._onModelAdded.fire(s.model),s.model}setMode(e,t){if(!t)return;const o=this._models[MODEL_ID(e.uri)];o&&o.setLanguage(t)}getModels(){const e=[],t=Object.keys(this._models);for(let o=0,i=t.length;o<i;o++){const i=t[o];e.push(this._models[i].model)}return e}getModel(e){const t=MODEL_ID(e),o=this._models[t];return o?o.model:null}getSemanticTokensProviderStyling(e){return this._semanticStyling.get(e)}_onWillDispose(t){const o=MODEL_ID(t.uri),i=this._models[o],s=this._undoRedoService.getUriComparisonKey(t.uri)!==t.uri.toString();let n=!1,r=0;if(s||this._shouldRestoreUndoStack()&&schemaShouldMaintainUndoRedoElements(t.uri)){const e=this._undoRedoService.getElements(t.uri);if(e.past.length>0||e.future.length>0){for(const o of e.past)isEditStackElement(o)&&o.matchesResource(t.uri)&&(n=!0,r+=o.heapSize(t.uri),o.setModel(t.uri));for(const o of e.future)isEditStackElement(o)&&o.matchesResource(t.uri)&&(n=!0,r+=o.heapSize(t.uri),o.setModel(t.uri))}}const a=e.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK;if(n)if(!s&&r>a){const e=i.model.getInitialUndoRedoSnapshot();null!==e&&this._undoRedoService.restoreSnapshot(e)}else this._ensureDisposedModelsHeapSize(a-r),this._undoRedoService.setElementsValidFlag(t.uri,!1,(e=>isEditStackElement(e)&&e.matchesResource(t.uri))),this._insertDisposedModel(new DisposedModelInfo(t.uri,i.model.getInitialUndoRedoSnapshot(),Date.now(),s,r,computeModelSha1(t),t.getVersionId(),t.getAlternativeVersionId()));else if(!s){const e=i.model.getInitialUndoRedoSnapshot();null!==e&&this._undoRedoService.restoreSnapshot(e)}delete this._models[o],i.dispose(),delete this._modelCreationOptionsByLanguageAndResource[t.getLanguageIdentifier().language+t.uri],this._onModelRemoved.fire(t)}_onDidChangeLanguage(t,o){const i=o.oldLanguage,s=t.getLanguageIdentifier().language,n=this.getCreationOptions(i,t.uri,t.isForSimpleWidget),r=this.getCreationOptions(s,t.uri,t.isForSimpleWidget);e._setModelOptionsForModel(t,r,n),this._onModelModeChanged.fire({model:t,oldModeId:i})}};ModelServiceImpl.MAX_MEMORY_FOR_CLOSED_FILES_UNDO_STACK=20971520,ModelServiceImpl=__decorate([__param(0,IConfigurationService),__param(1,ITextResourcePropertiesService),__param(2,IThemeService),__param(3,ILogService),__param(4,IUndoRedoService)],ModelServiceImpl);export{ModelServiceImpl};export const SEMANTIC_HIGHLIGHTING_SETTING_ID="editor.semanticHighlighting";export function isSemanticColoringEnabled(e,t,o){var i;const s=null===(i=o.getValue("editor.semanticHighlighting",{overrideIdentifier:e.getLanguageIdentifier().language,resource:e.uri}))||void 0===i?void 0:i.enabled;return"boolean"==typeof s?s:t.getColorTheme().semanticHighlighting}class SemanticColoringFeature extends Disposable{constructor(e,t,o,i){super(),this._watchers=Object.create(null),this._semanticStyling=i;const s=e=>{this._watchers[e.uri.toString()]=new ModelSemanticColoring(e,t,this._semanticStyling)},n=(e,t)=>{t.dispose(),delete this._watchers[e.uri.toString()]},r=()=>{for(let i of e.getModels()){const e=this._watchers[i.uri.toString()];isSemanticColoringEnabled(i,t,o)?e||s(i):e&&n(i,e)}};this._register(e.onModelAdded((e=>{isSemanticColoringEnabled(e,t,o)&&s(e)}))),this._register(e.onModelRemoved((e=>{const t=this._watchers[e.uri.toString()];t&&n(e,t)}))),this._register(o.onDidChangeConfiguration((e=>{e.affectsConfiguration("editor.semanticHighlighting")&&r()}))),this._register(t.onDidColorThemeChange(r))}}class SemanticStyling extends Disposable{constructor(e,t){super(),this._themeService=e,this._logService=t,this._caches=new WeakMap,this._register(this._themeService.onDidColorThemeChange((()=>{this._caches=new WeakMap})))}get(e){return this._caches.has(e)||this._caches.set(e,new SemanticTokensProviderStyling(e.getLegend(),this._themeService,this._logService)),this._caches.get(e)}}class SemanticTokensResponse{constructor(e,t,o){this._provider=e,this.resultId=t,this.data=o}dispose(){this._provider.releaseDocumentSemanticTokens(this.resultId)}}export class ModelSemanticColoring extends Disposable{constructor(e,t,o){super(),this._isDisposed=!1,this._model=e,this._semanticStyling=o,this._fetchDocumentSemanticTokens=this._register(new RunOnceScheduler((()=>this._fetchDocumentSemanticTokensNow()),ModelSemanticColoring.FETCH_DOCUMENT_SEMANTIC_TOKENS_DELAY)),this._currentDocumentResponse=null,this._currentDocumentRequestCancellationTokenSource=null,this._documentProvidersChangeListeners=[],this._register(this._model.onDidChangeContent((()=>{this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule()}))),this._register(this._model.onDidChangeLanguage((()=>{this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule(0)})));const i=()=>{dispose(this._documentProvidersChangeListeners),this._documentProvidersChangeListeners=[];for(const t of DocumentSemanticTokensProviderRegistry.all(e))"function"==typeof t.onDidChange&&this._documentProvidersChangeListeners.push(t.onDidChange((()=>this._fetchDocumentSemanticTokens.schedule(0))))};i(),this._register(DocumentSemanticTokensProviderRegistry.onDidChange((()=>{i(),this._fetchDocumentSemanticTokens.schedule()}))),this._register(t.onDidColorThemeChange((e=>{this._setDocumentSemanticTokens(null,null,null,[]),this._fetchDocumentSemanticTokens.schedule()}))),this._fetchDocumentSemanticTokens.schedule(0)}dispose(){this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._currentDocumentRequestCancellationTokenSource&&(this._currentDocumentRequestCancellationTokenSource.cancel(),this._currentDocumentRequestCancellationTokenSource=null),this._setDocumentSemanticTokens(null,null,null,[]),this._isDisposed=!0,super.dispose()}_fetchDocumentSemanticTokensNow(){if(this._currentDocumentRequestCancellationTokenSource)return;const e=new CancellationTokenSource,t=this._currentDocumentResponse&&this._currentDocumentResponse.resultId||null,o=getDocumentSemanticTokens(this._model,t,e.token);if(!o)return void(this._currentDocumentResponse&&this._model.setSemanticTokens(null,!1));const{provider:i,request:s}=o;this._currentDocumentRequestCancellationTokenSource=e;const n=[],r=this._model.onDidChangeContent((e=>{n.push(e)})),a=this._semanticStyling.get(i);s.then((e=>{this._currentDocumentRequestCancellationTokenSource=null,r.dispose(),this._setDocumentSemanticTokens(i,e||null,a,n)}),(e=>{e&&(errors.isPromiseCanceledError(e)||"string"==typeof e.message&&-1!==e.message.indexOf("busy"))||errors.onUnexpectedError(e),this._currentDocumentRequestCancellationTokenSource=null,r.dispose(),n.length>0&&(this._fetchDocumentSemanticTokens.isScheduled()||this._fetchDocumentSemanticTokens.schedule())}))}static _copy(e,t,o,i,s){for(let n=0;n<s;n++)o[i+n]=e[t+n]}_setDocumentSemanticTokens(e,t,o,i){const s=this._currentDocumentResponse,n=()=>{i.length>0&&!this._fetchDocumentSemanticTokens.isScheduled()&&this._fetchDocumentSemanticTokens.schedule()};if(this._currentDocumentResponse&&(this._currentDocumentResponse.dispose(),this._currentDocumentResponse=null),this._isDisposed)e&&t&&e.releaseDocumentSemanticTokens(t.resultId);else if(e&&o){if(!t)return this._model.setSemanticTokens(null,!0),void n();if(isSemanticTokensEdits(t)){if(!s)return void this._model.setSemanticTokens(null,!0);if(0===t.edits.length)t={resultId:t.resultId,data:s.data};else{let e=0;for(const o of t.edits)e+=(o.data?o.data.length:0)-o.deleteCount;const o=s.data,i=new Uint32Array(o.length+e);let n=o.length,r=i.length;for(let e=t.edits.length-1;e>=0;e--){const s=t.edits[e],a=n-(s.start+s.deleteCount);a>0&&(ModelSemanticColoring._copy(o,n-a,i,r-a,a),r-=a),s.data&&(ModelSemanticColoring._copy(s.data,0,i,r-s.data.length,s.data.length),r-=s.data.length),n=s.start}n>0&&ModelSemanticColoring._copy(o,0,i,0,n),t={resultId:t.resultId,data:i}}}if(isSemanticTokens(t)){this._currentDocumentResponse=new SemanticTokensResponse(e,t.resultId,t.data);const s=toMultilineTokens2(t,o,this._model.getLanguageIdentifier());if(i.length>0)for(const e of i)for(const t of s)for(const o of e.changes)t.applyEdit(o.range,o.text);this._model.setSemanticTokens(s,!0)}else this._model.setSemanticTokens(null,!0);n()}else this._model.setSemanticTokens(null,!1)}}ModelSemanticColoring.FETCH_DOCUMENT_SEMANTIC_TOKENS_DELAY=300;
//# sourceMappingURL=/sm/bfa60d8970753b8463209f3e5401f7873b2f098f9819e8c8ffadbe3aa1517904.map