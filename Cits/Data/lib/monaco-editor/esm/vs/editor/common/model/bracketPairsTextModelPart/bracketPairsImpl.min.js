/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/monaco-editor@0.33.0/esm/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsImpl.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{Emitter}from"../../../../base/common/event.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../../base/common/lifecycle.js";import{BracketPairsTree}from"./bracketPairsTree/bracketPairsTree.js";import{ignoreBracketsInToken}from"../../languages/supports.js";import{BracketsUtils}from"../../languages/supports/richEditBrackets.js";export class BracketPairsTextModelPart extends Disposable{constructor(e,t){super(),this.textModel=e,this.languageConfigurationService=t,this.bracketPairsTree=this._register(new MutableDisposable),this.onDidChangeEmitter=new Emitter,this.onDidChange=this.onDidChangeEmitter.event,this.bracketsRequested=!1,this._register(this.languageConfigurationService.onDidChange((e=>{var t;e.languageId&&!(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.didLanguageChange(e.languageId))||(this.bracketPairsTree.clear(),this.updateBracketPairsTree())})))}get isDocumentSupported(){return this.textModel.getValueLength()<=5e6}handleDidChangeOptions(e){this.bracketPairsTree.clear(),this.updateBracketPairsTree()}handleDidChangeLanguage(e){this.bracketPairsTree.clear(),this.updateBracketPairsTree()}handleDidChangeContent(e){var t;null===(t=this.bracketPairsTree.value)||void 0===t||t.object.handleContentChanged(e)}handleDidChangeBackgroundTokenizationState(){var e;null===(e=this.bracketPairsTree.value)||void 0===e||e.object.handleDidChangeBackgroundTokenizationState()}handleDidChangeTokens(e){var t;null===(t=this.bracketPairsTree.value)||void 0===t||t.object.handleDidChangeTokens(e)}updateBracketPairsTree(){if(this.bracketsRequested&&this.isDocumentSupported){if(!this.bracketPairsTree.value){const e=new DisposableStore;this.bracketPairsTree.value=createDisposableRef(e.add(new BracketPairsTree(this.textModel,(e=>this.languageConfigurationService.getLanguageConfiguration(e)))),e),e.add(this.bracketPairsTree.value.object.onDidChange((e=>this.onDidChangeEmitter.fire(e)))),this.onDidChangeEmitter.fire()}}else this.bracketPairsTree.value&&(this.bracketPairsTree.clear(),this.onDidChangeEmitter.fire())}getBracketPairsInRange(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketPairsInRange(e,!1))||[]}getBracketPairsInRangeWithMinIndentation(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketPairsInRange(e,!0))||[]}getBracketsInRange(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketsInRange(e))||[]}findMatchingBracketUp(e,t,n){const r=e.toLowerCase(),a=this.textModel.validatePosition(t),i=this.textModel.getLanguageIdAtPosition(a.lineNumber,a.column),s=this.languageConfigurationService.getLanguageConfiguration(i).brackets;if(!s)return null;const o=s.textIsBracket[r];return o?stripBracketSearchCanceled(this._findMatchingBracketUp(o,a,createTimeBasedContinueBracketSearchPredicate(n))):null}matchBracket(e,t){const n=createTimeBasedContinueBracketSearchPredicate(t);return this._matchBracket(this.textModel.validatePosition(e),n)}_establishBracketSearchOffsets(e,t,n,r){const a=t.getCount(),i=t.getLanguageId(r);let s=Math.max(0,e.column-1-n.maxBracketLength);for(let e=r-1;e>=0;e--){const n=t.getEndOffset(e);if(n<=s)break;if(ignoreBracketsInToken(t.getStandardTokenType(e))||t.getLanguageId(e)!==i){s=n;break}}let o=Math.min(t.getLineContent().length,e.column-1+n.maxBracketLength);for(let e=r+1;e<a;e++){const n=t.getStartOffset(e);if(n>=o)break;if(ignoreBracketsInToken(t.getStandardTokenType(e))||t.getLanguageId(e)!==i){o=n;break}}return{searchStartOffset:s,searchEndOffset:o}}_matchBracket(e,t){const n=e.lineNumber,r=this.textModel.getLineTokens(n),a=this.textModel.getLineContent(n),i=r.findTokenIndexAtOffset(e.column-1);if(i<0)return null;const s=this.languageConfigurationService.getLanguageConfiguration(r.getLanguageId(i)).brackets;if(s&&!ignoreBracketsInToken(r.getStandardTokenType(i))){let{searchStartOffset:o,searchEndOffset:c}=this._establishBracketSearchOffsets(e,r,s,i),l=null;for(;;){const r=BracketsUtils.findNextBracketInRange(s.forwardRegex,n,a,o,c);if(!r)break;if(r.startColumn<=e.column&&e.column<=r.endColumn){const e=a.substring(r.startColumn-1,r.endColumn-1).toLowerCase(),n=this._matchFoundBracket(r,s.textIsBracket[e],s.textIsOpenBracket[e],t);if(n){if(n instanceof BracketSearchCanceled)return null;l=n}}o=r.endColumn-1}if(l)return l}if(i>0&&r.getStartOffset(i)===e.column-1){const s=i-1,o=this.languageConfigurationService.getLanguageConfiguration(r.getLanguageId(s)).brackets;if(o&&!ignoreBracketsInToken(r.getStandardTokenType(s))){const{searchStartOffset:i,searchEndOffset:c}=this._establishBracketSearchOffsets(e,r,o,s),l=BracketsUtils.findPrevBracketInRange(o.reversedRegex,n,a,i,c);if(l&&l.startColumn<=e.column&&e.column<=l.endColumn){const e=a.substring(l.startColumn-1,l.endColumn-1).toLowerCase(),n=this._matchFoundBracket(l,o.textIsBracket[e],o.textIsOpenBracket[e],t);if(n)return n instanceof BracketSearchCanceled?null:n}}}return null}_matchFoundBracket(e,t,n,r){if(!t)return null;const a=n?this._findMatchingBracketDown(t,e.getEndPosition(),r):this._findMatchingBracketUp(t,e.getStartPosition(),r);return a?a instanceof BracketSearchCanceled?a:[e,a]:null}_findMatchingBracketUp(e,t,n){const r=e.languageId,a=e.reversedRegex;let i=-1,s=0;const o=(t,r,o,c)=>{for(;;){if(n&&++s%100==0&&!n())return BracketSearchCanceled.INSTANCE;const l=BracketsUtils.findPrevBracketInRange(a,t,r,o,c);if(!l)break;const g=r.substring(l.startColumn-1,l.endColumn-1).toLowerCase();if(e.isOpen(g)?i++:e.isClose(g)&&i--,0===i)return l;c=l.startColumn-1}return null};for(let e=t.lineNumber;e>=1;e--){const n=this.textModel.getLineTokens(e),a=n.getCount(),i=this.textModel.getLineContent(e);let s=a-1,c=i.length,l=i.length;e===t.lineNumber&&(s=n.findTokenIndexAtOffset(t.column-1),c=t.column-1,l=t.column-1);let g=!0;for(;s>=0;s--){const t=n.getLanguageId(s)===r&&!ignoreBracketsInToken(n.getStandardTokenType(s));if(t)g?c=n.getStartOffset(s):(c=n.getStartOffset(s),l=n.getEndOffset(s));else if(g&&c!==l){const t=o(e,i,c,l);if(t)return t}g=t}if(g&&c!==l){const t=o(e,i,c,l);if(t)return t}}return null}_findMatchingBracketDown(e,t,n){const r=e.languageId,a=e.forwardRegex;let i=1,s=0;const o=(t,r,o,c)=>{for(;;){if(n&&++s%100==0&&!n())return BracketSearchCanceled.INSTANCE;const l=BracketsUtils.findNextBracketInRange(a,t,r,o,c);if(!l)break;const g=r.substring(l.startColumn-1,l.endColumn-1).toLowerCase();if(e.isOpen(g)?i++:e.isClose(g)&&i--,0===i)return l;o=l.endColumn-1}return null},c=this.textModel.getLineCount();for(let e=t.lineNumber;e<=c;e++){const n=this.textModel.getLineTokens(e),a=n.getCount(),i=this.textModel.getLineContent(e);let s=0,c=0,l=0;e===t.lineNumber&&(s=n.findTokenIndexAtOffset(t.column-1),c=t.column-1,l=t.column-1);let g=!0;for(;s<a;s++){const t=n.getLanguageId(s)===r&&!ignoreBracketsInToken(n.getStandardTokenType(s));if(t)g||(c=n.getStartOffset(s)),l=n.getEndOffset(s);else if(g&&c!==l){const t=o(e,i,c,l);if(t)return t}g=t}if(g&&c!==l){const t=o(e,i,c,l);if(t)return t}}return null}findPrevBracket(e){const t=this.textModel.validatePosition(e);let n=null,r=null;for(let e=t.lineNumber;e>=1;e--){const a=this.textModel.getLineTokens(e),i=a.getCount(),s=this.textModel.getLineContent(e);let o=i-1,c=s.length,l=s.length;if(e===t.lineNumber){o=a.findTokenIndexAtOffset(t.column-1),c=t.column-1,l=t.column-1;const e=a.getLanguageId(o);n!==e&&(n=e,r=this.languageConfigurationService.getLanguageConfiguration(n).brackets)}let g=!0;for(;o>=0;o--){const t=a.getLanguageId(o);if(n!==t){if(r&&g&&c!==l){const t=BracketsUtils.findPrevBracketInRange(r.reversedRegex,e,s,c,l);if(t)return this._toFoundBracket(r,t);g=!1}n=t,r=this.languageConfigurationService.getLanguageConfiguration(n).brackets}const i=!!r&&!ignoreBracketsInToken(a.getStandardTokenType(o));if(i)g?c=a.getStartOffset(o):(c=a.getStartOffset(o),l=a.getEndOffset(o));else if(r&&g&&c!==l){const t=BracketsUtils.findPrevBracketInRange(r.reversedRegex,e,s,c,l);if(t)return this._toFoundBracket(r,t)}g=i}if(r&&g&&c!==l){const t=BracketsUtils.findPrevBracketInRange(r.reversedRegex,e,s,c,l);if(t)return this._toFoundBracket(r,t)}}return null}findNextBracket(e){const t=this.textModel.validatePosition(e),n=this.textModel.getLineCount();let r=null,a=null;for(let e=t.lineNumber;e<=n;e++){const n=this.textModel.getLineTokens(e),i=n.getCount(),s=this.textModel.getLineContent(e);let o=0,c=0,l=0;if(e===t.lineNumber){o=n.findTokenIndexAtOffset(t.column-1),c=t.column-1,l=t.column-1;const e=n.getLanguageId(o);r!==e&&(r=e,a=this.languageConfigurationService.getLanguageConfiguration(r).brackets)}let g=!0;for(;o<i;o++){const t=n.getLanguageId(o);if(r!==t){if(a&&g&&c!==l){const t=BracketsUtils.findNextBracketInRange(a.forwardRegex,e,s,c,l);if(t)return this._toFoundBracket(a,t);g=!1}r=t,a=this.languageConfigurationService.getLanguageConfiguration(r).brackets}const i=!!a&&!ignoreBracketsInToken(n.getStandardTokenType(o));if(i)g||(c=n.getStartOffset(o)),l=n.getEndOffset(o);else if(a&&g&&c!==l){const t=BracketsUtils.findNextBracketInRange(a.forwardRegex,e,s,c,l);if(t)return this._toFoundBracket(a,t)}g=i}if(a&&g&&c!==l){const t=BracketsUtils.findNextBracketInRange(a.forwardRegex,e,s,c,l);if(t)return this._toFoundBracket(a,t)}}return null}findEnclosingBrackets(e,t){const n=createTimeBasedContinueBracketSearchPredicate(t),r=this.textModel.validatePosition(e),a=this.textModel.getLineCount(),i=new Map;let s=[];const o=(e,t)=>{if(!i.has(e)){const n=[];for(let e=0,r=t?t.brackets.length:0;e<r;e++)n[e]=0;i.set(e,n)}s=i.get(e)};let c=0;const l=(e,t,r,a,i)=>{for(;;){if(n&&++c%100==0&&!n())return BracketSearchCanceled.INSTANCE;const o=BracketsUtils.findNextBracketInRange(e.forwardRegex,t,r,a,i);if(!o)break;const l=r.substring(o.startColumn-1,o.endColumn-1).toLowerCase(),g=e.textIsBracket[l];if(g&&(g.isOpen(l)?s[g.index]++:g.isClose(l)&&s[g.index]--,-1===s[g.index]))return this._matchFoundBracket(o,g,!1,n);a=o.endColumn-1}return null};let g=null,u=null;for(let e=r.lineNumber;e<=a;e++){const t=this.textModel.getLineTokens(e),n=t.getCount(),a=this.textModel.getLineContent(e);let i=0,s=0,c=0;if(e===r.lineNumber){i=t.findTokenIndexAtOffset(r.column-1),s=r.column-1,c=r.column-1;const e=t.getLanguageId(i);g!==e&&(g=e,u=this.languageConfigurationService.getLanguageConfiguration(g).brackets,o(g,u))}let d=!0;for(;i<n;i++){const n=t.getLanguageId(i);if(g!==n){if(u&&d&&s!==c){const t=l(u,e,a,s,c);if(t)return stripBracketSearchCanceled(t);d=!1}g=n,u=this.languageConfigurationService.getLanguageConfiguration(g).brackets,o(g,u)}const r=!!u&&!ignoreBracketsInToken(t.getStandardTokenType(i));if(r)d||(s=t.getStartOffset(i)),c=t.getEndOffset(i);else if(u&&d&&s!==c){const t=l(u,e,a,s,c);if(t)return stripBracketSearchCanceled(t)}d=r}if(u&&d&&s!==c){const t=l(u,e,a,s,c);if(t)return stripBracketSearchCanceled(t)}}return null}_toFoundBracket(e,t){if(!t)return null;let n=this.textModel.getValueInRange(t);n=n.toLowerCase();const r=e.textIsBracket[n];return r?{range:t,open:r.open,close:r.close,isOpen:e.textIsOpenBracket[n]}:null}}function createDisposableRef(e,t){return{object:e,dispose:()=>null==t?void 0:t.dispose()}}function createTimeBasedContinueBracketSearchPredicate(e){if(void 0===e)return()=>!0;{const t=Date.now();return()=>Date.now()-t<=e}}class BracketSearchCanceled{constructor(){this._searchCanceledBrand=void 0}}function stripBracketSearchCanceled(e){return e instanceof BracketSearchCanceled?null:e}BracketSearchCanceled.INSTANCE=new BracketSearchCanceled;
//# sourceMappingURL=/sm/c29a47492d9ba43b1c2585add73b1e262ebb0c6084eb9447934e2670a273cb43.map