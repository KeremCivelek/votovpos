/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/monaco-editor@0.27.0/esm/vs/editor/common/controller/cursor.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{onUnexpectedError}from"../../../base/common/errors.js";import*as strings from"../../../base/common/strings.js";import{CursorCollection}from"./cursorCollection.js";import{CursorColumns,CursorContext,CursorState,EditOperationResult}from"./cursorCommon.js";import{DeleteOperations}from"./cursorDeleteOperations.js";import{TypeOperations,TypeWithAutoClosingCommand}from"./cursorTypeOperations.js";import{Range}from"../core/range.js";import{Selection}from"../core/selection.js";import{ModelInjectedTextChangedEvent}from"../model/textModelEvents.js";import{ViewCursorStateChangedEvent,ViewRevealRangeRequestEvent}from"../view/viewEvents.js";import{dispose,Disposable}from"../../../base/common/lifecycle.js";import{CursorStateChangedEvent}from"../viewModel/viewModelEventDispatcher.js";export class CursorModelState{constructor(e,t){this.modelVersionId=e.getVersionId(),this.cursorState=t.getCursorStates()}equals(e){if(!e)return!1;if(this.modelVersionId!==e.modelVersionId)return!1;if(this.cursorState.length!==e.cursorState.length)return!1;for(let t=0,s=this.cursorState.length;t<s;t++)if(!this.cursorState[t].equals(e.cursorState[t]))return!1;return!0}}class AutoClosedAction{constructor(e,t,s){this._model=e,this._autoClosedCharactersDecorations=t,this._autoClosedEnclosingDecorations=s}static getAllAutoClosedCharacters(e){let t=[];for(const s of e)t=t.concat(s.getAutoClosedCharactersRanges());return t}dispose(){this._autoClosedCharactersDecorations=this._model.deltaDecorations(this._autoClosedCharactersDecorations,[]),this._autoClosedEnclosingDecorations=this._model.deltaDecorations(this._autoClosedEnclosingDecorations,[])}getAutoClosedCharactersRanges(){let e=[];for(let t=0;t<this._autoClosedCharactersDecorations.length;t++){const s=this._model.getDecorationRange(this._autoClosedCharactersDecorations[t]);s&&e.push(s)}return e}isValid(e){let t=[];for(let e=0;e<this._autoClosedEnclosingDecorations.length;e++){const s=this._model.getDecorationRange(this._autoClosedEnclosingDecorations[e]);if(s&&(t.push(s),s.startLineNumber!==s.endLineNumber))return!1}t.sort(Range.compareRangesUsingStarts),e.sort(Range.compareRangesUsingStarts);for(let s=0;s<e.length;s++){if(s>=t.length)return!1;if(!t[s].strictContainsRange(e[s]))return!1}return!0}}export class CursorsController extends Disposable{constructor(e,t,s,o){super(),this._model=e,this._knownModelVersionId=this._model.getVersionId(),this._viewModel=t,this._coordinatesConverter=s,this.context=new CursorContext(this._model,this._viewModel,this._coordinatesConverter,o),this._cursors=new CursorCollection(this.context),this._hasFocus=!1,this._isHandling=!1,this._isDoingComposition=!1,this._selectionsWhenCompositionStarted=null,this._columnSelectData=null,this._autoClosedActions=[],this._prevEditOperationType=0}dispose(){this._cursors.dispose(),this._autoClosedActions=dispose(this._autoClosedActions),super.dispose()}updateConfiguration(e){this.context=new CursorContext(this._model,this._viewModel,this._coordinatesConverter,e),this._cursors.updateContext(this.context)}onLineMappingChanged(e){this._knownModelVersionId===this._model.getVersionId()&&this.setStates(e,"viewModel",0,this.getCursorStates())}setHasFocus(e){this._hasFocus=e}_validateAutoClosedActions(){if(this._autoClosedActions.length>0){let e=this._cursors.getSelections();for(let t=0;t<this._autoClosedActions.length;t++){const s=this._autoClosedActions[t];s.isValid(e)||(s.dispose(),this._autoClosedActions.splice(t,1),t--)}}}getPrimaryCursorState(){return this._cursors.getPrimaryCursor()}getLastAddedCursorIndex(){return this._cursors.getLastAddedCursorIndex()}getCursorStates(){return this._cursors.getAll()}setStates(e,t,s,o){let i=!1;null!==o&&o.length>CursorsController.MAX_CURSOR_COUNT&&(o=o.slice(0,CursorsController.MAX_CURSOR_COUNT),i=!0);const r=new CursorModelState(this._model,this);return this._cursors.setStates(o),this._cursors.normalize(),this._columnSelectData=null,this._validateAutoClosedActions(),this._emitStateChangedIfNecessary(e,t,s,r,i)}setCursorColumnSelectData(e){this._columnSelectData=e}revealPrimary(e,t,s,o){const i=this._cursors.getViewPositions();if(i.length>1)this._emitCursorRevealRange(e,t,null,this._cursors.getViewSelections(),0,s,o);else{const r=i[0],n=new Range(r.lineNumber,r.column,r.lineNumber,r.column);this._emitCursorRevealRange(e,t,n,null,0,s,o)}}_revealPrimaryCursor(e,t,s,o,i){const r=this._cursors.getViewPositions();if(r.length>1)this._emitCursorRevealRange(e,t,null,this._cursors.getViewSelections(),s,o,i);else{const n=r[0],l=new Range(n.lineNumber,n.column,n.lineNumber,n.column);this._emitCursorRevealRange(e,t,l,null,s,o,i)}}_emitCursorRevealRange(e,t,s,o,i,r,n){e.emitViewEvent(new ViewRevealRangeRequestEvent(t,s,o,i,r,n))}saveState(){let e=[];const t=this._cursors.getSelections();for(let s=0,o=t.length;s<o;s++){const o=t[s];e.push({inSelectionMode:!o.isEmpty(),selectionStart:{lineNumber:o.selectionStartLineNumber,column:o.selectionStartColumn},position:{lineNumber:o.positionLineNumber,column:o.positionColumn}})}return e}restoreState(e,t){let s=[];for(let e=0,o=t.length;e<o;e++){const o=t[e];let i=1,r=1;o.position&&o.position.lineNumber&&(i=o.position.lineNumber),o.position&&o.position.column&&(r=o.position.column);let n=i,l=r;o.selectionStart&&o.selectionStart.lineNumber&&(n=o.selectionStart.lineNumber),o.selectionStart&&o.selectionStart.column&&(l=o.selectionStart.column),s.push({selectionStartLineNumber:n,selectionStartColumn:l,positionLineNumber:i,positionColumn:r})}this.setStates(e,"restoreState",0,CursorState.fromModelSelections(s)),this.revealPrimary(e,"restoreState",!0,1)}onModelContentChanged(e,t){if(t instanceof ModelInjectedTextChangedEvent){const t=this._cursors.readSelectionFromMarkers();this.setStates(e,"modelChange",2,CursorState.fromModelSelections(t))}else{if(this._knownModelVersionId=t.versionId,this._isHandling)return;const s=t.containsEvent(1);if(this._prevEditOperationType=0,s)this._cursors.dispose(),this._cursors=new CursorCollection(this.context),this._validateAutoClosedActions(),this._emitStateChangedIfNecessary(e,"model",1,null,!1);else if(this._hasFocus&&t.resultingSelection&&t.resultingSelection.length>0){const s=CursorState.fromModelSelections(t.resultingSelection);this.setStates(e,"modelChange",t.isUndoing?5:t.isRedoing?6:2,s)&&this._revealPrimaryCursor(e,"modelChange",0,!0,0)}else{const t=this._cursors.readSelectionFromMarkers();this.setStates(e,"modelChange",2,CursorState.fromModelSelections(t))}}}getSelection(){return this._cursors.getPrimaryCursor().modelState.selection}getTopMostViewPosition(){return this._cursors.getTopMostViewPosition()}getBottomMostViewPosition(){return this._cursors.getBottomMostViewPosition()}getCursorColumnSelectData(){if(this._columnSelectData)return this._columnSelectData;const e=this._cursors.getPrimaryCursor(),t=e.viewState.selectionStart.getStartPosition(),s=e.viewState.position;return{isReal:!1,fromViewLineNumber:t.lineNumber,fromViewVisualColumn:CursorColumns.visibleColumnFromColumn2(this.context.cursorConfig,this._viewModel,t),toViewLineNumber:s.lineNumber,toViewVisualColumn:CursorColumns.visibleColumnFromColumn2(this.context.cursorConfig,this._viewModel,s)}}getSelections(){return this._cursors.getSelections()}setSelections(e,t,s,o){this.setStates(e,t,o,CursorState.fromModelSelections(s))}getPrevEditOperationType(){return this._prevEditOperationType}setPrevEditOperationType(e){this._prevEditOperationType=e}_pushAutoClosedAction(e,t){let s=[],o=[];for(let i=0,r=e.length;i<r;i++)s.push({range:e[i],options:{description:"auto-closed-character",inlineClassName:"auto-closed-character",stickiness:1}}),o.push({range:t[i],options:{description:"auto-closed-enclosing",stickiness:1}});const i=this._model.deltaDecorations([],s),r=this._model.deltaDecorations([],o);this._autoClosedActions.push(new AutoClosedAction(this._model,i,r))}_executeEditOperation(e){if(!e)return;e.shouldPushStackElementBefore&&this._model.pushStackElement();const t=CommandExecutor.executeCommands(this._model,this._cursors.getSelections(),e.commands);if(t){this._interpretCommandResult(t);let s=[],o=[];for(let t=0;t<e.commands.length;t++){const i=e.commands[t];i instanceof TypeWithAutoClosingCommand&&i.enclosingRange&&i.closeCharacterRange&&(s.push(i.closeCharacterRange),o.push(i.enclosingRange))}s.length>0&&this._pushAutoClosedAction(s,o),this._prevEditOperationType=e.type}e.shouldPushStackElementAfter&&this._model.pushStackElement()}_interpretCommandResult(e){e&&0!==e.length||(e=this._cursors.readSelectionFromMarkers()),this._columnSelectData=null,this._cursors.setSelections(e),this._cursors.normalize()}_emitStateChangedIfNecessary(e,t,s,o,i){const r=new CursorModelState(this._model,this);if(r.equals(o))return!1;const n=this._cursors.getSelections(),l=this._cursors.getViewSelections();if(e.emitViewEvent(new ViewCursorStateChangedEvent(l,n)),!o||o.cursorState.length!==r.cursorState.length||r.cursorState.some(((e,t)=>!e.modelState.equals(o.cursorState[t].modelState)))){const l=o?o.cursorState.map((e=>e.modelState.selection)):null,a=o?o.modelVersionId:0;e.emitOutgoingEvent(new CursorStateChangedEvent(l,n,a,r.modelVersionId,t||"keyboard",s,i))}return!0}_findAutoClosingPairs(e){if(!e.length)return null;let t=[];for(let s=0,o=e.length;s<o;s++){const o=e[s];if(!o.text||o.text.indexOf("\n")>=0)return null;const i=o.text.match(/([)\]}>'"`])([^)\]}>'"`]*)$/);if(!i)return null;const r=i[1],n=this.context.cursorConfig.autoClosingPairs.autoClosingPairsCloseSingleChar.get(r);if(!n||1!==n.length)return null;const l=n[0].open,a=o.text.length-i[2].length-1,c=o.text.lastIndexOf(l,a-1);if(-1===c)return null;t.push([c,a])}return t}executeEdits(e,t,s,o){let i=null;"snippet"===t&&(i=this._findAutoClosingPairs(s)),i&&(s[0]._isTracked=!0);let r=[],n=[];const l=this._model.pushEditOperations(this.getSelections(),s,(e=>{if(i)for(let t=0,s=i.length;t<s;t++){const[s,o]=i[t],l=e[t],a=l.range.startLineNumber,c=l.range.startColumn-1+s,u=l.range.startColumn-1+o;r.push(new Range(a,u+1,a,u+2)),n.push(new Range(a,c+1,a,u+2))}const t=o(e);return t&&(this._isHandling=!0),t}));l&&(this._isHandling=!1,this.setSelections(e,t,l,0)),r.length>0&&this._pushAutoClosedAction(r,n)}_executeEdit(e,t,s,o=0){if(this.context.cursorConfig.readOnly)return;const i=new CursorModelState(this._model,this);this._cursors.stopTrackingSelections(),this._isHandling=!0;try{this._cursors.ensureValidState(),e()}catch(e){onUnexpectedError(e)}this._isHandling=!1,this._cursors.startTrackingSelections(),this._validateAutoClosedActions(),this._emitStateChangedIfNecessary(t,s,o,i,!1)&&this._revealPrimaryCursor(t,s,0,!0,0)}setIsDoingComposition(e){this._isDoingComposition=e}getAutoClosedCharacters(){return AutoClosedAction.getAllAutoClosedCharacters(this._autoClosedActions)}startComposition(e){this._selectionsWhenCompositionStarted=this.getSelections().slice(0)}endComposition(e,t){this._executeEdit((()=>{"keyboard"===t&&(this._executeEditOperation(TypeOperations.compositionEndWithInterceptors(this._prevEditOperationType,this.context.cursorConfig,this._model,this._selectionsWhenCompositionStarted,this.getSelections(),this.getAutoClosedCharacters())),this._selectionsWhenCompositionStarted=null)}),e,t)}type(e,t,s){this._executeEdit((()=>{if("keyboard"===s){const e=t.length;let s=0;for(;s<e;){const e=strings.nextCharLength(t,s),o=t.substr(s,e);this._executeEditOperation(TypeOperations.typeWithInterceptors(this._isDoingComposition,this._prevEditOperationType,this.context.cursorConfig,this._model,this.getSelections(),this.getAutoClosedCharacters(),o)),s+=e}}else this._executeEditOperation(TypeOperations.typeWithoutInterceptors(this._prevEditOperationType,this.context.cursorConfig,this._model,this.getSelections(),t))}),e,s)}compositionType(e,t,s,o,i,r){if(0!==t.length||0!==s||0!==o)this._executeEdit((()=>{this._executeEditOperation(TypeOperations.compositionType(this._prevEditOperationType,this.context.cursorConfig,this._model,this.getSelections(),t,s,o,i))}),e,r);else if(0!==i){const t=this.getSelections().map((e=>{const t=e.getPosition();return new Selection(t.lineNumber,t.column+i,t.lineNumber,t.column+i)}));this.setSelections(e,r,t,0)}}paste(e,t,s,o,i){this._executeEdit((()=>{this._executeEditOperation(TypeOperations.paste(this.context.cursorConfig,this._model,this.getSelections(),t,s,o||[]))}),e,i,4)}cut(e,t){this._executeEdit((()=>{this._executeEditOperation(DeleteOperations.cut(this.context.cursorConfig,this._model,this.getSelections()))}),e,t)}executeCommand(e,t,s){this._executeEdit((()=>{this._cursors.killSecondaryCursors(),this._executeEditOperation(new EditOperationResult(0,[t],{shouldPushStackElementBefore:!1,shouldPushStackElementAfter:!1}))}),e,s)}executeCommands(e,t,s){this._executeEdit((()=>{this._executeEditOperation(new EditOperationResult(0,t,{shouldPushStackElementBefore:!1,shouldPushStackElementAfter:!1}))}),e,s)}}CursorsController.MAX_CURSOR_COUNT=1e4;class CommandExecutor{static executeCommands(e,t,s){const o={model:e,selectionsBefore:t,trackedRanges:[],trackedRangesDirection:[]},i=this._innerExecuteCommands(o,s);for(let e=0,t=o.trackedRanges.length;e<t;e++)o.model._setTrackedRange(o.trackedRanges[e],null,0);return i}static _innerExecuteCommands(e,t){if(this._arrayIsEmpty(t))return null;const s=this._getEditOperations(e,t);if(0===s.operations.length)return null;const o=s.operations,i=this._getLoserCursorMap(o);if(i.hasOwnProperty("0"))return console.warn("Ignoring commands"),null;let r=[];for(let e=0,t=o.length;e<t;e++)i.hasOwnProperty(o[e].identifier.major.toString())||r.push(o[e]);s.hadTrackedEditOperation&&r.length>0&&(r[0]._isTracked=!0);let n=e.model.pushEditOperations(e.selectionsBefore,r,(s=>{let o=[];for(let t=0;t<e.selectionsBefore.length;t++)o[t]=[];for(const e of s)e.identifier&&o[e.identifier.major].push(e);const i=(e,t)=>e.identifier.minor-t.identifier.minor;let r=[];for(let s=0;s<e.selectionsBefore.length;s++)o[s].length>0?(o[s].sort(i),r[s]=t[s].computeCursorState(e.model,{getInverseEditOperations:()=>o[s],getTrackedSelection:t=>{const s=parseInt(t,10),o=e.model._getTrackedRange(e.trackedRanges[s]);return 0===e.trackedRangesDirection[s]?new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn):new Selection(o.endLineNumber,o.endColumn,o.startLineNumber,o.startColumn)}})):r[s]=e.selectionsBefore[s];return r}));n||(n=e.selectionsBefore);let l=[];for(let e in i)i.hasOwnProperty(e)&&l.push(parseInt(e,10));l.sort(((e,t)=>t-e));for(const e of l)n.splice(e,1);return n}static _arrayIsEmpty(e){for(let t=0,s=e.length;t<s;t++)if(e[t])return!1;return!0}static _getEditOperations(e,t){let s=[],o=!1;for(let i=0,r=t.length;i<r;i++){const r=t[i];if(r){const t=this._getEditOperationsFromCommand(e,i,r);s=s.concat(t.operations),o=o||t.hadTrackedEditOperation}}return{operations:s,hadTrackedEditOperation:o}}static _getEditOperationsFromCommand(e,t,s){let o=[],i=0;const r=(e,r,n=!1)=>{Range.isEmpty(e)&&""===r||o.push({identifier:{major:t,minor:i++},range:e,text:r,forceMoveMarkers:n,isAutoWhitespaceEdit:s.insertsAutoWhitespace})};let n=!1;const l={addEditOperation:r,addTrackedEditOperation:(e,t,s)=>{n=!0,r(e,t,s)},trackSelection:(t,s)=>{const o=Selection.liftSelection(t);let i;if(o.isEmpty())if("boolean"==typeof s)i=s?2:3;else{const t=e.model.getLineMaxColumn(o.startLineNumber);i=o.startColumn===t?2:3}else i=1;const r=e.trackedRanges.length,n=e.model._setTrackedRange(null,o,i);return e.trackedRanges[r]=n,e.trackedRangesDirection[r]=o.getDirection(),r.toString()}};try{s.getEditOperations(e.model,l)}catch(e){return onUnexpectedError(e),{operations:[],hadTrackedEditOperation:!1}}return{operations:o,hadTrackedEditOperation:n}}static _getLoserCursorMap(e){(e=e.slice(0)).sort(((e,t)=>-Range.compareRangesUsingEnds(e.range,t.range)));let t={};for(let s=1;s<e.length;s++){const o=e[s-1],i=e[s];if(Range.getStartPosition(o.range).isBefore(Range.getEndPosition(i.range))){let r;r=o.identifier.major>i.identifier.major?o.identifier.major:i.identifier.major,t[r.toString()]=!0;for(let t=0;t<e.length;t++)e[t].identifier.major===r&&(e.splice(t,1),t<s&&s--,t--);s>0&&s--}}return t}}
//# sourceMappingURL=/sm/f144aeb230b20fe5456beb9c7e68744d6b77a81f4de6312316cf9ab89b195041.map