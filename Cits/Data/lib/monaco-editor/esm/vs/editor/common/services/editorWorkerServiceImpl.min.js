/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/monaco-editor@0.27.0/esm/vs/editor/common/services/editorWorkerServiceImpl.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __decorate=this&&this.__decorate||function(e,r,t,o){var i,s=arguments.length,n=s<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,r,t,o);else for(var d=e.length-1;d>=0;d--)(i=e[d])&&(n=(s<3?i(n):s>3?i(r,t,n):i(r,t))||n);return s>3&&n&&Object.defineProperty(r,t,n),n},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}},__awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,s){function n(e){try{l(o.next(e))}catch(e){s(e)}}function d(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(n,d)}l((o=o.apply(e,r||[])).next())}))};import{IntervalTimer,timeout}from"../../../base/common/async.js";import{Disposable,dispose,toDisposable,DisposableStore}from"../../../base/common/lifecycle.js";import{SimpleWorkerClient,logOnceWebWorkerWarning}from"../../../base/common/worker/simpleWorker.js";import{DefaultWorkerFactory}from"../../../base/worker/defaultWorkerFactory.js";import{Range}from"../core/range.js";import*as modes from"../modes.js";import{LanguageConfigurationRegistry}from"../modes/languageConfigurationRegistry.js";import{EditorSimpleWorker}from"./editorSimpleWorker.js";import{IModelService}from"./modelService.js";import{ITextResourceConfigurationService}from"./textResourceConfigurationService.js";import{regExpFlags}from"../../../base/common/strings.js";import{isNonEmptyArray}from"../../../base/common/arrays.js";import{ILogService}from"../../../platform/log/common/log.js";import{StopWatch}from"../../../base/common/stopwatch.js";import{canceled}from"../../../base/common/errors.js";const STOP_SYNC_MODEL_DELTA_TIME_MS=6e4,STOP_WORKER_DELTA_TIME_MS=3e5;function canSyncModel(e,r){let t=e.getModel(r);return!!t&&!t.isTooLargeForSyncing()}let EditorWorkerServiceImpl=class extends Disposable{constructor(e,r,t){super(),this._modelService=e,this._workerManager=this._register(new WorkerManager(this._modelService)),this._logService=t,this._register(modes.LinkProviderRegistry.register("*",{provideLinks:(e,r)=>canSyncModel(this._modelService,e.uri)?this._workerManager.withWorker().then((r=>r.computeLinks(e.uri))).then((e=>e&&{links:e})):Promise.resolve({links:[]})})),this._register(modes.CompletionProviderRegistry.register("*",new WordBasedCompletionItemProvider(this._workerManager,r,this._modelService)))}dispose(){super.dispose()}canComputeDiff(e,r){return canSyncModel(this._modelService,e)&&canSyncModel(this._modelService,r)}computeDiff(e,r,t,o){return this._workerManager.withWorker().then((i=>i.computeDiff(e,r,t,o)))}computeMoreMinimalEdits(e,r){if(isNonEmptyArray(r)){if(!canSyncModel(this._modelService,e))return Promise.resolve(r);const t=StopWatch.create(!0),o=this._workerManager.withWorker().then((t=>t.computeMoreMinimalEdits(e,r)));return o.finally((()=>this._logService.trace("FORMAT#computeMoreMinimalEdits",e.toString(!0),t.elapsed()))),Promise.race([o,timeout(1e3).then((()=>r))])}return Promise.resolve(void 0)}canNavigateValueSet(e){return canSyncModel(this._modelService,e)}navigateValueSet(e,r,t){return this._workerManager.withWorker().then((o=>o.navigateValueSet(e,r,t)))}canComputeWordRanges(e){return canSyncModel(this._modelService,e)}computeWordRanges(e,r){return this._workerManager.withWorker().then((t=>t.computeWordRanges(e,r)))}};EditorWorkerServiceImpl=__decorate([__param(0,IModelService),__param(1,ITextResourceConfigurationService),__param(2,ILogService)],EditorWorkerServiceImpl);export{EditorWorkerServiceImpl};class WordBasedCompletionItemProvider{constructor(e,r,t){this._debugDisplayName="wordbasedCompletions",this._workerManager=e,this._configurationService=r,this._modelService=t}provideCompletionItems(e,r){return __awaiter(this,void 0,void 0,(function*(){const t=this._configurationService.getValue(e.uri,r,"editor");if(!t.wordBasedSuggestions)return;const o=[];if("currentDocument"===t.wordBasedSuggestionsMode)canSyncModel(this._modelService,e.uri)&&o.push(e.uri);else for(const r of this._modelService.getModels())canSyncModel(this._modelService,r.uri)&&(r===e?o.unshift(r.uri):"allDocuments"!==t.wordBasedSuggestionsMode&&r.getLanguageIdentifier().id!==e.getLanguageIdentifier().id||o.push(r.uri));if(0===o.length)return;const i=LanguageConfigurationRegistry.getWordDefinition(e.getLanguageIdentifier().id),s=e.getWordAtPosition(r),n=s?new Range(r.lineNumber,s.startColumn,r.lineNumber,s.endColumn):Range.fromPositions(r),d=n.setEndPosition(r.lineNumber,r.column),l=yield this._workerManager.withWorker(),c=yield l.textualSuggest(o,null==s?void 0:s.word,i);return c?{duration:c.duration,suggestions:c.words.map((e=>({kind:18,label:e,insertText:e,range:{insert:d,replace:n}})))}:void 0}))}}class WorkerManager extends Disposable{constructor(e){super(),this._modelService=e,this._editorWorkerClient=null,this._lastWorkerUsedTime=(new Date).getTime(),this._register(new IntervalTimer).cancelAndSet((()=>this._checkStopIdleWorker()),Math.round(15e4)),this._register(this._modelService.onModelRemoved((e=>this._checkStopEmptyWorker())))}dispose(){this._editorWorkerClient&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null),super.dispose()}_checkStopEmptyWorker(){if(!this._editorWorkerClient)return;0===this._modelService.getModels().length&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}_checkStopIdleWorker(){if(!this._editorWorkerClient)return;(new Date).getTime()-this._lastWorkerUsedTime>3e5&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}withWorker(){return this._lastWorkerUsedTime=(new Date).getTime(),this._editorWorkerClient||(this._editorWorkerClient=new EditorWorkerClient(this._modelService,!1,"editorWorkerService")),Promise.resolve(this._editorWorkerClient)}}class EditorModelManager extends Disposable{constructor(e,r,t){if(super(),this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),this._proxy=e,this._modelService=r,!t){let e=new IntervalTimer;e.cancelAndSet((()=>this._checkStopModelSync()),Math.round(3e4)),this._register(e)}}dispose(){for(let e in this._syncedModels)dispose(this._syncedModels[e]);this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),super.dispose()}ensureSyncedResources(e){for(const r of e){let e=r.toString();this._syncedModels[e]||this._beginModelSync(r),this._syncedModels[e]&&(this._syncedModelsLastUsedTime[e]=(new Date).getTime())}}_checkStopModelSync(){let e=(new Date).getTime(),r=[];for(let t in this._syncedModelsLastUsedTime){e-this._syncedModelsLastUsedTime[t]>6e4&&r.push(t)}for(const e of r)this._stopModelSync(e)}_beginModelSync(e){let r=this._modelService.getModel(e);if(!r)return;if(r.isTooLargeForSyncing())return;let t=e.toString();this._proxy.acceptNewModel({url:r.uri.toString(),lines:r.getLinesContent(),EOL:r.getEOL(),versionId:r.getVersionId()});const o=new DisposableStore;o.add(r.onDidChangeContent((e=>{this._proxy.acceptModelChanged(t.toString(),e)}))),o.add(r.onWillDispose((()=>{this._stopModelSync(t)}))),o.add(toDisposable((()=>{this._proxy.acceptRemovedModel(t)}))),this._syncedModels[t]=o}_stopModelSync(e){let r=this._syncedModels[e];delete this._syncedModels[e],delete this._syncedModelsLastUsedTime[e],dispose(r)}}class SynchronousWorkerClient{constructor(e){this._instance=e,this._proxyObj=Promise.resolve(this._instance)}dispose(){this._instance.dispose()}getProxyObject(){return this._proxyObj}}export class EditorWorkerHost{constructor(e){this._workerClient=e}fhr(e,r){return this._workerClient.fhr(e,r)}}export class EditorWorkerClient extends Disposable{constructor(e,r,t){super(),this._disposed=!1,this._modelService=e,this._keepIdleModels=r,this._workerFactory=new DefaultWorkerFactory(t),this._worker=null,this._modelManager=null}fhr(e,r){throw new Error("Not implemented!")}_getOrCreateWorker(){if(!this._worker)try{this._worker=this._register(new SimpleWorkerClient(this._workerFactory,"vs/editor/common/services/editorSimpleWorker",new EditorWorkerHost(this)))}catch(e){logOnceWebWorkerWarning(e),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null))}return this._worker}_getProxy(){return this._getOrCreateWorker().getProxyObject().then(void 0,(e=>(logOnceWebWorkerWarning(e),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null)),this._getOrCreateWorker().getProxyObject())))}_getOrCreateModelManager(e){return this._modelManager||(this._modelManager=this._register(new EditorModelManager(e,this._modelService,this._keepIdleModels))),this._modelManager}_withSyncedResources(e){return this._disposed?Promise.reject(canceled()):this._getProxy().then((r=>(this._getOrCreateModelManager(r).ensureSyncedResources(e),r)))}computeDiff(e,r,t,o){return this._withSyncedResources([e,r]).then((i=>i.computeDiff(e.toString(),r.toString(),t,o)))}computeMoreMinimalEdits(e,r){return this._withSyncedResources([e]).then((t=>t.computeMoreMinimalEdits(e.toString(),r)))}computeLinks(e){return this._withSyncedResources([e]).then((r=>r.computeLinks(e.toString())))}textualSuggest(e,r,t){return __awaiter(this,void 0,void 0,(function*(){const o=yield this._withSyncedResources(e),i=t.source,s=regExpFlags(t);return o.textualSuggest(e.map((e=>e.toString())),r,i,s)}))}computeWordRanges(e,r){return this._withSyncedResources([e]).then((t=>{let o=this._modelService.getModel(e);if(!o)return Promise.resolve(null);let i=LanguageConfigurationRegistry.getWordDefinition(o.getLanguageIdentifier().id),s=i.source,n=regExpFlags(i);return t.computeWordRanges(e.toString(),r,s,n)}))}navigateValueSet(e,r,t){return this._withSyncedResources([e]).then((o=>{let i=this._modelService.getModel(e);if(!i)return null;let s=LanguageConfigurationRegistry.getWordDefinition(i.getLanguageIdentifier().id),n=s.source,d=regExpFlags(s);return o.navigateValueSet(e.toString(),r,t,n,d)}))}dispose(){super.dispose(),this._disposed=!0}}
//# sourceMappingURL=/sm/6976a97b3feffe08da90e2afcb8921fbda3a2e41b6eb73fc049e4f3b636fcfa1.map